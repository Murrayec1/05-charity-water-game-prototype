<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <!-- Responsive viewport for mobile and tablet -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="An educational game about the daily journey many girls take to collect water, inspired by charity: water's mission.">
  <meta name="keywords" content="water crisis, education, charity water, social impact, interactive game">
  <title>The Long Walk: A Journey for Water</title>
  <style>
    /* Skip navigation link for accessibility */
    .skip-link {
      position: absolute;
      left: -9999px;
      width: 1px;
      height: 1px;
      overflow: hidden;
      z-index: 9999;
      background: #2E9DF7;
      color: #fff;
      padding: 10px;
      text-decoration: none;
      font-weight: bold;
    }
    
    .skip-link:focus {
      left: 10px;
      top: 10px;
      width: auto;
      height: auto;
      overflow: visible;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #f4f4f4, #e8f4f8);
      color: #111;
      font-weight: bold;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px 20px 60px 20px; /* Add bottom padding for footer */
    }

    #gameContainer {
      background: #fff;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      max-width: 600px;
      width: 100%;
      position: relative;
      overflow: hidden;
      /* We'll set background images from JavaScript */
      background-size: cover;
      background-position: center;
      transition: background-image 0.5s;
      color: #111; /* Ensure text is very dark on white */
      font-weight: bold; /* Bolder text */
      padding-bottom: 0; /* Remove extra space at bottom */
      /* Removed border for better mobile visibility */
    }

    h1 {
      color: #00263a; /* Dark blue for excellent contrast on white */
      font-size: 2rem;
      text-align: center;
      font-weight: bold;
      letter-spacing: 1px;
      margin-bottom: 15px;
    }

    #storyText {
      font-size: 1.2rem;
      margin: 20px 0;
      color: #111; /* Very dark text */
      font-weight: bold;
      text-shadow: 1px 1px 2px #fff, 0 0 2px #fff;
      background: rgba(255,255,255,0.65); /* More transparent background */
      backdrop-filter: blur(3px); /* Add blur effect */
      border-radius: 6px;
      padding: 10px 12px;
      box-sizing: border-box;
      border: 1px solid rgba(44,157,247,0.2); /* Subtle border */
    }

    #choices {
      display: flex; /* Use flexbox to center options */
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      margin: 0 auto;
    }

    .choiceBtn {
      display: block;
      background-color: #2E9DF7; /* charity: water blue */
      color: #fff;
      border: none; /* Removed border for cleaner mobile look */
      padding: 12px;
      margin: 10px 0;
      width: 100%;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: bold;
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(46, 157, 247, 0.3);
      margin-left: auto;
      margin-right: auto;
      text-decoration: none;
    }

    .choiceBtn:focus {
      outline: 4px solid #FFC907;
      outline-offset: 3px;
      box-shadow: 0 0 0 2px #fff, 0 0 0 6px #FFC907;
    }

    .choiceBtn:hover {
      background-color: #FFC907; /* charity: water yellow on hover */
      color: #00263a; /* dark text on yellow background */
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(255, 201, 7, 0.4);
    }

    /* Ensure keyboard navigation visibility */
    .choiceBtn:focus-visible {
      outline: 4px solid #FFC907;
      outline-offset: 3px;
    }

    #statusBar {
      margin-top: 20px;
      font-size: 1rem;
      color: #00263a;
      background: rgba(255, 201, 7, 0.75); /* More transparent background */
      backdrop-filter: blur(3px); /* Add blur effect */
      padding: 8px 12px;
      border-radius: 6px;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(255, 201, 7, 0.3);
      border: 1px solid rgba(255, 201, 7, 0.4); /* Subtle border */
    }

    /* Score area with charity: water branding */
    #scoreArea {
      background: rgba(255, 201, 7, 0.75); /* More transparent background */
      backdrop-filter: blur(3px); /* Add blur effect */
      color: #00263a;
      border-radius: 6px;
      padding: 8px 12px;
      margin-bottom: 8px;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(255, 201, 7, 0.3);
      border: 1px solid rgba(255, 201, 7, 0.4); /* Subtle border */
    }

    /* Character styles */
    #characterContainer {
      position: absolute; /* Place the character exactly over the map line */
      margin-bottom: 0;
      left: 0; /* Will be set by JS */
      top: 0;  /* Will be set by JS */
      width: 40px;
      height: 75px;
      pointer-events: none;
      z-index: 10; /* Above the SVG path */
      transition: left 0.7s, top 0.7s;
    }
    #characterSprite {
      width: 100%;
      height: auto;
      display: block;
    }
    #jerryCanIcon {
      position: absolute;
      right: 8px;
      bottom: 18px;
      width: 26px;
      height: 26px;
      z-index: 3;
    }

    /* Landing page overlay styles */
    #landingPage {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #fff; /* Solid white for best contrast */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start; /* Changed from center to flex-start */
      z-index: 10;
      color: #111;
      font-weight: bold;
      overflow-y: auto; /* Allow scrolling if content is too tall */
      padding: 20px 15px 40px 15px; /* Add padding to ensure content isn't cut off */
      box-sizing: border-box;
    }
    #landingTitle {
      font-size: 2.2rem;
      color: #00263a !important; /* Dark blue for better contrast - important to override h1 styles */
      text-shadow: none !important; /* Remove white text shadow that blends with background */
      margin-bottom: 10px;
      text-align: center;
      font-weight: bold;
      background: none !important; /* Remove any gradient background */
      -webkit-background-clip: initial !important; /* Reset background clip */
      background-clip: initial !important; /* Reset background clip */
      -webkit-text-fill-color: #00263a !important; /* Ensure solid color text */
    }
    #landingSubtitle {
      font-size: 1.1rem;
      color: #111;
      margin-bottom: 30px;
      text-align: center;
      max-width: 400px;
      font-weight: bold;
      text-shadow: 1px 1px 2px #fff, 0 0 2px #fff;
    }
    .landingBtn {
      background-color: #2E9DF7; /* charity: water blue */
      color: #fff;
      border: none; /* Removed border for cleaner mobile look */
      padding: 14px 32px;
      margin: 10px;
      border-radius: 6px;
      font-size: 1.1rem;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
      letter-spacing: 0.5px;
      box-shadow: 0 3px 6px rgba(46, 157, 247, 0.3);
      text-decoration: none;
    }
    
    .landingBtn:focus {
      outline: 4px solid #FFC907;
      outline-offset: 3px;
      box-shadow: 0 0 0 2px #fff, 0 0 0 6px #FFC907;
    }
    
    .landingBtn:focus-visible {
      outline: 4px solid #FFC907;
      outline-offset: 3px;
    }
    
    .landingBtn:hover {
      background-color: #FFC907; /* charity: water yellow on hover */
      color: #00263a; /* dark text on yellow background */
      transform: translateY(-2px);
      box-shadow: 0 5px 10px rgba(255, 201, 7, 0.4);
    }
    .landingBtn[style*="background-color:#FFC907"] {
      color: #222 !important; /* Ensure readable text on yellow */
    }
    .landingBtn[style*="background-color:#FFC907"]:hover {
      background-color: #e6b800 !important;
      color: #222 !important;
    }
    a:focus {
      outline: 3px solid #FFC907;
      outline-offset: 2px;
    }
    #didYouKnow {
      background: #FFFBEA;
      border-left: 6px solid #FFC907;
      color: #111;
      font-size: 1rem;
      margin: 16px auto 0 auto;
      padding: 12px 18px 12px 14px;
      border-radius: 6px;
      box-shadow: 0 2px 8px #0001, 1px 1px 2px #fff;
      max-width: 500px;
      display: none;
      transition: opacity 0.5s;
      font-weight: bold;
      text-shadow: 1px 1px 2px #fff, 0 0 2px #fff;
      text-align: center;
    }
    #didYouKnow a {
      color: #2E9DF7;
      text-decoration: underline;
      font-size: 0.98em;
      font-weight: bold;
    }
    #progressPath {
      width: 100%;
      max-width: 600px;
      margin: 0 auto 10px auto;
      user-select: none;
      font-weight: bold;
      position: relative; /* Needed for absolute positioning of the character */
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.85);
      padding-bottom: 8px;
      z-index: 5;
    }
    #pathSVG {
      display: block;
      margin: 0 auto;
      background: none;
    }
    #milestoneLabels span {
      min-width: 40px;
      text-align: center;
      color: #222; /* Darker for better contrast */
      font-weight: bold;
      text-shadow: 1px 1px 2px #fff, 0 0 2px #fff;
    }

    /* Make SVGs and overlays responsive */
    #characterContainer, #characterSprite {
      max-width: 100vw;
      max-height: 25vh;
      width: 40px;
      height: 75px;
    }
    #progressPath, #pathSVG {
      width: 100%;
      max-width: 600px;
      min-width: 180px;
    }
    .choiceBtn, .landingBtn {
      font-size: 1rem;
      padding: 12px;
      width: 100%;
      max-width: 350px;
      box-sizing: border-box;
    }
    /* Responsive overlay for cut scenes and directions */
    #directionsCutScene, #schoolEndingScene, #glassCutScene, #wellCelebrationScene {
      max-width: 100vw;
      max-height: 100vh;
      overflow-y: auto;
      padding: 10px;
      box-sizing: border-box;
    }
    
    /* Better responsive support for direction overlays */
    @media (max-height: 600px) {
      #directionsCutScene > div,
      #schoolEndingScene > div,
      #glassCutScene > div {
        max-height: 80vh;
        overflow-y: auto;
        padding: 15px;
      }
      #directionsCutScene img,
      #schoolEndingScene img,
      #glassCutScene img {
        max-width: 100px;
      }
    }
    /* Improved responsive design for all screen sizes */
    @media (max-width: 600px) {
      body {
        padding: 10px 10px 50px 10px; /* Reduced padding for more space */
      }
      #gameContainer {
        padding: 10px; /* Reduced padding */
        max-width: 98vw;
        margin: 0 auto;
      }
      #landingPage {
        padding: 15px 10px 60px 10px; /* Increased bottom padding for mobile */
        box-sizing: border-box;
        justify-content: flex-start; /* Ensure content starts at top */
        min-height: 100vh; /* Ensure full height */
      }
      h1 {
        font-size: 1.4rem;
        margin-bottom: 10px;
      }
      #landingTitle {
        font-size: 1.6rem; /* Slightly smaller for mobile */
        margin-bottom: 6px; /* Reduced margin */
      }
      #landingSubtitle {
        font-size: 0.95rem;
        margin-bottom: 15px; /* Reduced margin */
        max-width: 95%;
      }
      /* Reduce spacing around images */
      #landingPage img {
        margin-bottom: 10px !important;
      }
      #landingPage header img {
        margin-bottom: 8px !important;
        max-width: 280px !important; /* Larger logo on mobile */
      }
      /* Make hero images bigger on mobile for better visibility */
      #landingPage img[alt*="Young girl carrying"] {
        max-width: 220px !important;
      }
      #landingPage img[alt*="Happy girl drinking"] {
        max-width: 180px !important;
      }
      #scoreArea, #statusBar, #storyText {
        font-size: 1em;
        padding: 8px 6px;
        margin: 8px 0; /* Reduced margins */
      }
      .choiceBtn, .landingBtn {
        font-size: 0.95rem;
        padding: 14px 12px; /* More generous padding for easier tapping */
        margin: 8px 0; /* Reduced margins between buttons */
        width: 100%;
        max-width: none; /* Remove max-width restriction */
      }
      .landingBtn {
        padding: 16px 12px; /* Even more padding for landing buttons */
        margin: 8px auto; /* Center the buttons */
        display: block;
        width: 100%;
        max-width: 280px; /* Set reasonable max-width */
      }
      #characterContainer, #characterSprite {
        width: 28px;
        height: 52px;
      }
      #progressPath, #pathSVG {
        min-width: 120px;
      }
      #milestoneLabels {
        font-size: 0.6em;
      }
      /* Difficulty selection improvements for mobile */
      nav > div {
        margin-bottom: 15px !important;
      }
      nav > div > div {
        flex-direction: column !important;
        gap: 8px !important;
      }
      nav > div label {
        font-size: 0.9rem !important;
        padding: 8px;
        background: rgba(255,255,255,0.8);
        border-radius: 4px;
        margin: 2px 0;
      }
      /* Ensure navigation buttons area has enough space */
      nav {
        width: 100% !important;
        margin-bottom: 20px !important;
      }
      nav > div:last-child {
        margin-bottom: 30px !important; /* Extra space for button container */
      }
    }

    /* Tablet responsive design */
    @media (min-width: 601px) and (max-width: 1024px) {
      #gameContainer {
        max-width: 700px;
        padding: 25px;
      }
      h1 {
        font-size: 2.2rem;
      }
      #storyText {
        font-size: 1.3rem;
      }
      .choiceBtn, .landingBtn {
        font-size: 1.1rem;
        padding: 14px;
        max-width: 400px;
      }
      #landingTitle {
        font-size: 2.5rem;
      }
      #landingSubtitle {
        font-size: 1.2rem;
        max-width: 500px;
      }
    }

    /* Large screen responsive design */
    @media (min-width: 1025px) {
      #gameContainer {
        max-width: 800px;
        padding: 30px;
      }
      h1 {
        font-size: 2.5rem;
      }
      #storyText {
        font-size: 1.4rem;
      }
      .choiceBtn, .landingBtn {
        font-size: 1.2rem;
        padding: 16px;
        max-width: 450px;
      }
      #landingTitle {
        font-size: 3rem;
      }
      #landingSubtitle {
        font-size: 1.3rem;
        max-width: 600px;
      }
    }

    /* High contrast mode support */
    @media (prefers-contrast: high) {
      body {
        background: #000;
        color: #fff;
      }
      #gameContainer {
        background: #fff;
        border: 4px solid #000;
        color: #000;
      }
      .choiceBtn {
        border: 3px solid #000;
      }
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
      #characterContainer {
        transition: none;
      }
      #gameContainer {
        transition: none;
      }
    }
  </style>
</head>
<body>
  <!-- Skip navigation link for accessibility -->
  <a href="#gameContent" class="skip-link">Skip to main content</a>
  
  <!-- Landing Page Overlay -->
  <main id="landingPage" role="dialog" aria-modal="true" aria-labelledby="landingTitle" aria-describedby="landingSubtitle">
    <header>
      <img src="img/cw_logo_horizontal.png" alt="charity: water - bringing clean and safe drinking water to people in developing countries" style="max-width: 320px; margin-bottom: 15px; height: auto;">
    </header>
    
    <!-- Hero image showing the journey -->
    <img src="img/Girl with jerry can.jpg" alt="Young girl carrying a large yellow water container on a dusty path, representing the daily journey millions of girls take to collect water" style="max-width: 250px; height: auto; border-radius: 12px; border: 3px solid #FFC907; margin-bottom: 15px;">
    
    <h1 id="landingTitle">💧 The Long Walk: A Journey for Water</h1>
    <p id="landingSubtitle">
      Every day, millions of girls walk miles for clean water.<br>
      Can you help her reach a brighter future?<br>
      <span style="color:#2E9DF7; font-weight:bold;">Play to experience her journey.</span>
    </p>
    
    <!-- Show clean water image as motivation -->
    <img src="img/Girl with cup of water..jpg" alt="Happy girl drinking from a clean cup of water, showing the positive impact of access to clean water" style="max-width: 200px; height: auto; border-radius: 8px; border: 2px solid #2E9DF7; margin: 10px 0;">
    
    <nav>
      <!-- Difficulty Selection -->
      <div style="margin-bottom: 20px;">
        <h2 style="font-size: 1.3rem; color: #005073; margin-bottom: 10px;">Choose Your Difficulty:</h2>
        <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 15px;">
          <label style="display: flex; align-items: center; font-size: 1rem; color: #222; cursor: pointer;">
            <input type="radio" name="difficulty" value="easy" checked style="margin-right: 8px; transform: scale(1.2);">
            <span style="color: #4FCB53; font-weight: bold;">Easy</span> - 6 pts to win, 6 energy
          </label>
          <label style="display: flex; align-items: center; font-size: 1rem; color: #222; cursor: pointer;">
            <input type="radio" name="difficulty" value="normal" style="margin-right: 8px; transform: scale(1.2);">
            <span style="color: #2E9DF7; font-weight: bold;">Normal</span> - 10 pts to win, 4 energy
          </label>
          <label style="display: flex; align-items: center; font-size: 1rem; color: #222; cursor: pointer;">
            <input type="radio" name="difficulty" value="hard" style="margin-right: 8px; transform: scale(1.2);">
            <span style="color: #F5402C; font-weight: bold;">Hard</span> - 15 pts to win, 3 energy
          </label>
        </div>
      </div>
      
      <div style="display: flex; flex-direction: column; align-items: center; gap: 10px; width: 100%;">
        <button class="landingBtn" id="startGameBtn" aria-label="Start the interactive water journey game">Start Game</button>
        <a href="https://www.charitywater.org/main" target="_blank" rel="noopener" aria-label="Learn more about Charity: Water's mission and donate" style="text-decoration: none;">
          <button class="landingBtn" style="background-color:#FFC907; color:#00263a; border-color:#2E9DF7;">Learn More About charity: water</button>
        </a>
      </div>
    </nav>
  </main>

  <main id="gameContainer" style="display:none;" role="main" aria-label="Water journey game content" tabindex="-1">
    <!-- charity: water logo watermark -->
    <img src="img/cw_logo.png" alt="charity: water logo" style="position: absolute; top: 10px; right: 10px; width: 40px; height: 40px; opacity: 0.7; z-index: 5;">
    
    <header>
      <h1>The Long Walk: A Journey for Water</h1>
      <!-- Reset button for player control -->
      <button id="resetBtn" class="choiceBtn" style="max-width:200px; margin: 0 auto 10px auto; background-color:#F5402C;" aria-label="Reset game to beginning">Reset Game</button>
    </header>

    <!-- Add a clear score area at the top -->
    <section id="scoreSection" aria-label="Game progress">
      <div id="scoreArea" style="text-align:center; font-size:1.1em; margin-bottom:8px;" role="status" aria-live="polite">
        <div style="font-size: 0.9em; color: #666; margin-bottom: 4px;">
          <span id="difficultyDisplay">Easy Mode</span>
        </div>
        Journey Points: <span id="scoreValue">0</span> / <span id="goalValue">6</span>
      </div>
      
      <!-- Progress path directly under the character's feet -->
      <div id="progressPath" role="img" aria-label="Journey progress map showing path from home to water source and back to village">
        <!-- Place the character icon absolutely over the SVG path -->
        <div id="characterContainer" aria-hidden="true" style="position: absolute; transition: left 1.2s ease-in-out, top 1.2s ease-in-out, transform 0.2s ease-in-out;">
          <img id="characterSprite" src="img/Girl with jerry can.jpg" alt="" style="width: 40px; height: 75px; object-fit: cover; border-radius: 50%; border: 2px solid #FFC907;">
        </div>
        <svg id="pathSVG" width="100%" height="100" viewBox="0 0 800 100" style="max-width: 100%; min-width: 200px;" role="img" aria-labelledby="pathDesc">
          <title id="pathDesc">Journey map showing winding path from home village through forest to water source and back, with obstacles along the way</title>
          <!-- Extended winding path (brown) - much longer and more detailed with multiple curves -->
          <path d="M 60 80 Q 120 40 200 60 Q 280 85 360 45 Q 440 20 520 55 Q 600 80 680 35 Q 720 20 740 45" stroke="#8d5524" stroke-width="12" fill="none" stroke-linecap="round"/>
          <!-- Progress trail - will be dynamically updated -->
          <path id="progressTrail" d="M 60 80" stroke="#4FCB53" stroke-width="10" fill="none" stroke-linecap="round" style="opacity: 0.8; transition: d 1.2s ease-in-out;"/>
          <!-- Milestones (4 steps) - now just visual markers, not interactive -->
          <circle class="milestone" cx="60"  cy="80" r="13" fill="#FFC907" stroke="#bfa100" stroke-width="2" style="transition: all 0.3s ease;">
            <title>Home - Starting point of the journey</title>
          </circle>
          <circle class="milestone" cx="280" cy="85" r="11" fill="#FF902A" stroke="#F5402C" stroke-width="2" style="transition: all 0.3s ease;">
            <title>Obstacles - Challenges along the path</title>
          </circle>
          <circle class="milestone" cx="520" cy="55" r="11" fill="#8BD1CB" stroke="#159A48" stroke-width="2" style="transition: all 0.3s ease;">
            <title>Water Source - The destination for clean water</title>
          </circle>
          <circle class="milestone" cx="740" cy="45" r="13" fill="#2E9DF7" stroke="#005073" stroke-width="3" style="transition: all 0.3s ease;">
            <title>Village - Return home with water</title>
          </circle>
          <!-- Enhanced trees with much clearer and more recognizable visual design -->
          <g>
            <!-- Tree 1 - Near beginning -->
            <!-- Trunk -->
            <rect x="157" y="25" width="8" height="20" fill="#8B4513" rx="2"/>
            <!-- Main canopy -->
            <ellipse cx="161" cy="20" rx="18" ry="12" fill="#228B22"/>
            <!-- Secondary foliage layers for depth -->
            <ellipse cx="158" cy="18" rx="12" ry="8" fill="#32CD32"/>
            <ellipse cx="164" cy="22" rx="10" ry="6" fill="#90EE90"/>
            <!-- Small branches -->
            <circle cx="150" cy="25" r="4" fill="#228B22"/>
            <circle cx="172" cy="27" r="3" fill="#228B22"/>
          </g>
          <g>
            <!-- Tree 2 - Middle area -->
            <!-- Trunk -->
            <rect x="397" y="70" width="10" height="25" fill="#8B4513" rx="2"/>
            <!-- Main canopy -->
            <ellipse cx="402" cy="65" rx="20" ry="14" fill="#228B22"/>
            <!-- Secondary foliage layers -->
            <ellipse cx="398" cy="62" rx="14" ry="10" fill="#32CD32"/>
            <ellipse cx="406" cy="68" rx="12" ry="8" fill="#90EE90"/>
            <!-- Small branches -->
            <circle cx="388" cy="68" r="5" fill="#228B22"/>
            <circle cx="416" cy="70" r="4" fill="#228B22"/>
          </g>
          <g>
            <!-- Tree 3 - Near water source -->
            <!-- Trunk -->
            <rect x="587" y="15" width="7" height="18" fill="#8B4513" rx="2"/>
            <!-- Main canopy -->
            <ellipse cx="590" cy="12" rx="16" ry="10" fill="#228B22"/>
            <!-- Secondary foliage -->
            <ellipse cx="587" cy="10" rx="11" ry="7" fill="#32CD32"/>
            <ellipse cx="593" cy="14" rx="9" ry="5" fill="#90EE90"/>
            <!-- Small branches -->
            <circle cx="580" cy="16" r="3" fill="#228B22"/>
            <circle cx="600" cy="18" r="4" fill="#228B22"/>
          </g>
          <g>
            <!-- Tree 4 - Additional tree for longer path -->
            <!-- Trunk -->
            <rect x="667" y="25" width="9" height="22" fill="#8B4513" rx="2"/>
            <!-- Main canopy -->
            <ellipse cx="671" cy="20" rx="17" ry="11" fill="#228B22"/>
            <!-- Secondary foliage -->
            <ellipse cx="668" cy="18" rx="12" ry="8" fill="#32CD32"/>
            <ellipse cx="674" cy="22" rx="10" ry="6" fill="#90EE90"/>
            <!-- Small branches -->
            <circle cx="661" cy="24" r="4" fill="#228B22"/>
            <circle cx="681" cy="26" r="3" fill="#228B22"/>
          </g>
          <!-- Rocks and terrain features with better definition -->
          <g>
            <!-- Rock cluster 1 -->
            <ellipse cx="240" cy="90" rx="10" ry="5" fill="#A0522D" stroke="#8B4513" stroke-width="1"/>
            <ellipse cx="235" cy="87" rx="6" ry="3" fill="#D2691E"/>
            <ellipse cx="245" cy="88" rx="5" ry="3" fill="#CD853F"/>
          </g>
          <g>
            <!-- Rock cluster 2 -->
            <ellipse cx="460" cy="25" rx="8" ry="4" fill="#A0522D" stroke="#8B4513" stroke-width="1"/>
            <ellipse cx="455" cy="22" rx="5" ry="3" fill="#D2691E"/>
          </g>
          <g>
            <!-- Rock cluster 3 -->
            <ellipse cx="640" cy="80" rx="9" ry="5" fill="#A0522D" stroke="#8B4513" stroke-width="1"/>
            <ellipse cx="635" cy="77" rx="6" ry="3" fill="#D2691E"/>
            <ellipse cx="645" cy="78" rx="4" ry="2" fill="#CD853F"/>
          </g>
        </svg>
        <!-- Milestone labels for the journey map -->
        <div id="milestoneLabels" style="display: flex; justify-content: space-between; font-size: 0.7em; color: #555; margin-top: 16px; margin-bottom: 4px;" aria-hidden="true">
          <span>home</span>
          <span>obstacles</span>
          <span>water source</span>
          <span>village</span>
        </div>
      </div>
    </section>

    <section id="gameContent" aria-label="Game story and choices">
      <div id="storyText" role="status" aria-live="polite" style="background: rgba(255, 255, 255, 0.85); padding: 15px; border-radius: 8px; margin-bottom: 15px; backdrop-filter: blur(2px);">Click "Start" to begin the journey.</div>
      <div id="didYouKnow" style="display:none; background: rgba(255, 201, 7, 0.7); padding: 12px; border-radius: 6px; margin-bottom: 10px; backdrop-filter: blur(3px); border: 1px solid rgba(255, 201, 7, 0.4); text-align: center;" role="complementary" aria-label="Educational information">
        <!-- Did You Know box will be filled by JS -->
      </div>
      <div id="choices" role="group" aria-label="Available choices"></div>
    </section>

    <div id="statusBar" role="status" aria-live="polite" style="background: rgba(255, 255, 255, 0.8); padding: 8px 12px; border-radius: 6px; margin: 10px 0; backdrop-filter: blur(2px);"></div>
    
    <!-- Audio elements for ambient and SFX - NO BACKGROUND MUSIC -->
    <!-- UI interaction sounds - using simple working audio sources -->
    <audio id="sfxClick" preload="auto" aria-label="Click sound effect">
      <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAaBRsGHNzK6Z1HD..." type="audio/wav">
      <source src="https://www.soundjay.com/misc/sounds/bell-ringing-05.wav" type="audio/wav">
    </audio>
    <audio id="sfxButton" preload="auto" aria-label="Button press sound">
      <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj..." type="audio/wav">
    </audio>
    <audio id="sfxVictory" preload="auto" aria-label="Victory celebration sound">
      <source src="https://www.soundjay.com/misc/sounds/success-1.wav" type="audio/wav">
    </audio>
    <audio id="sfxLoss" preload="auto" aria-label="Loss sound">
      <source src="https://www.soundjay.com/misc/sounds/fail-buzzer-02.wav" type="audio/wav">
    </audio>
    
    <!-- Journey progression sounds -->
    <audio id="sfxPointsEarned" preload="auto" aria-label="Points earned sound">
      <source src="https://www.soundjay.com/misc/sounds/coin-drop-1.wav" type="audio/wav">
    </audio>
    <audio id="sfxEnergyGain" preload="auto" aria-label="Energy gained sound">
      <source src="https://www.soundjay.com/misc/sounds/power-up-05.wav" type="audio/wav">
    </audio>
    <audio id="sfxEnergyLoss" preload="auto" aria-label="Energy lost sound">
      <source src="https://www.soundjay.com/misc/sounds/power-down-01.wav" type="audio/wav">
    </audio>
    <audio id="sfxMovement" preload="auto" aria-label="Character movement sound">
      <source src="https://www.soundjay.com/misc/sounds/footstep-01.wav" type="audio/wav">
    </audio>
    <audio id="sfxMilestone" preload="auto" aria-label="Milestone reached sound">
      <source src="https://www.soundjay.com/misc/sounds/ding-idea-01.wav" type="audio/wav">
    </audio>
    
    <!-- Environmental and story sounds -->
    <audio id="sfxGlassBreak" preload="auto" aria-label="Glass breaking sound">
      <source src="https://www.soundjay.com/misc/sounds/glass-break-1.wav" type="audio/wav">
    </audio>
    <audio id="sfxSnakeHiss" preload="auto" aria-label="Snake hissing sound">
      <source src="https://www.soundjay.com/misc/sounds/snake-hiss-1.wav" type="audio/wav">
    </audio>
    <audio id="sfxDogBark" preload="auto" aria-label="Dog barking sound">
      <source src="https://www.soundjay.com/misc/sounds/dog-bark-1.wav" type="audio/wav">
    </audio>
    <audio id="sfxWaterSplash" preload="auto" aria-label="Water splash sound">
      <source src="https://www.soundjay.com/misc/sounds/water-drop-1.wav" type="audio/wav">
    </audio>
    <audio id="sfxCommunity" preload="auto" aria-label="Community celebration sound">
      <source src="https://www.soundjay.com/misc/sounds/crowd-cheer-1.wav" type="audio/wav">
    </audio>
    
    <!-- Educational and notification sounds -->
    <audio id="sfxFactAlert" preload="auto" aria-label="Educational fact notification">
      <source src="https://www.soundjay.com/misc/sounds/notification-1.wav" type="audio/wav">
    </audio>
    <audio id="sfxWarning" preload="auto" aria-label="Warning sound">
      <source src="https://www.soundjay.com/misc/sounds/warning-1.wav" type="audio/wav">
    </audio>
    
    <!-- Additional interactive sounds for enhanced experience -->
    <audio id="sfxWalk" preload="auto" aria-label="Walking on dirt path">
      <source src="https://www.soundjay.com/misc/sounds/footstep-dirt-01.wav" type="audio/wav">
    </audio>
    <audio id="sfxRest" preload="auto" aria-label="Rest and recovery sound">
      <source src="https://www.soundjay.com/misc/sounds/sigh-relief-01.wav" type="audio/wav">
    </audio>
    <audio id="sfxThrow" preload="auto" aria-label="Throwing object sound">
      <source src="https://www.soundjay.com/misc/sounds/whoosh-01.wav" type="audio/wav">
    </audio>
    <audio id="sfxSplash" preload="auto" aria-label="Water filling container">
      <source src="https://www.soundjay.com/misc/sounds/water-pour-01.wav" type="audio/wav">
    </audio>
    <audio id="sfxCrowd" preload="auto" aria-label="Villagers gathering">
      <source src="https://www.soundjay.com/misc/sounds/crowd-talking-01.wav" type="audio/wav">
    </audio>
    <audio id="sfxBirds" preload="auto" aria-label="Morning birds chirping">
      <source src="https://www.soundjay.com/misc/sounds/birds-chirping-01.wav" type="audio/wav">
    </audio>
    <audio id="sfxWind" preload="auto" aria-label="Gentle wind through trees">
      <source src="https://www.soundjay.com/misc/sounds/wind-light-01.wav" type="audio/wav">
    </audio>
    <audio id="sfxJerrycan" preload="auto" aria-label="Jerry can hitting ground">
      <source src="https://www.soundjay.com/misc/sounds/plastic-hit-01.wav" type="audio/wav">
    </audio>
    <audio id="sfxSchoolBell" preload="auto" aria-label="School bell ringing">
      <source src="https://www.soundjay.com/misc/sounds/school-bell-01.wav" type="audio/wav">
    </audio>
    <audio id="sfxGasp" preload="auto" aria-label="Surprised gasp">
      <source src="https://www.soundjay.com/misc/sounds/gasp-surprise-01.wav" type="audio/wav">
    </audio>
    <audio id="sfxHeart" preload="auto" aria-label="Heartbeat sound">
      <source src="https://www.soundjay.com/misc/sounds/heartbeat-01.wav" type="audio/wav">
    </audio>
    <audio id="sfxLaughter" preload="auto" aria-label="Children laughing">
      <source src="https://www.soundjay.com/misc/sounds/children-laugh-01.wav" type="audio/wav">
    </audio>
    
    <!-- Additional immersive sound effects for enhanced storytelling -->
    <audio id="sfxMorning" preload="auto" aria-label="Morning awakening sounds">
      <source src="https://www.soundjay.com/misc/sounds/rooster-crow-01.wav" type="audio/wav">
    </audio>
    <audio id="sfxVillage" preload="auto" aria-label="Village ambient sounds">
      <source src="https://www.soundjay.com/misc/sounds/marketplace-ambient-01.wav" type="audio/wav">
    </audio>
    <audio id="sfxRiver" preload="auto" aria-label="River flowing sounds">
      <source src="https://www.soundjay.com/misc/sounds/stream-water-01.wav" type="audio/wav">
    </audio>
    <audio id="sfxCelebration" preload="auto" aria-label="Community celebration">
      <source src="https://www.soundjay.com/misc/sounds/cheer-celebration-01.wav" type="audio/wav">
    </audio>
    <audio id="sfxFriendship" preload="auto" aria-label="Friendly conversation">
      <source src="https://www.soundjay.com/misc/sounds/conversation-happy-01.wav" type="audio/wav">
    </audio>
  </main>

  <script>
    let currentStep = 0;
    let energy = 4; // Will be set based on difficulty
    let score = 0; // Start Journey Points at 0
    let lastScore = 0; // Track last score for feedback
    let wentAlone = false; // Track if player chose 'Go alone'
    let returning = false; // Track if player is returning home
    
    // Difficulty system
    let currentDifficulty = 'easy'; // Default to easy
    const difficultySettings = {
      easy: {
        startingEnergy: 6,
        winCondition: 6,
        pointsPerChoice: 3,
        energyPenalty: 1,
        factDisplayTime: 30000, // 30 seconds
        name: "Easy",
        description: "More forgiving journey with helpful guidance"
      },
      normal: {
        startingEnergy: 4,
        winCondition: 10,
        pointsPerChoice: 2,
        energyPenalty: 1,
        factDisplayTime: 25000, // 25 seconds
        name: "Normal", 
        description: "Balanced challenge representing real experiences"
      },
      hard: {
        startingEnergy: 3,
        winCondition: 15,
        pointsPerChoice: 1,
        energyPenalty: 2,
        factDisplayTime: 20000, // 20 seconds
        name: "Hard",
        description: "Challenging journey requiring careful planning"
      }
    };

    const storyText = document.getElementById('storyText');
    const choicesContainer = document.getElementById('choices');
    const statusBar = document.getElementById('statusBar');

    // Progressive story: 8 steps with gradual movement along the path
    const storySteps = [
      {
        text: "You wake up early. Your family's only water source is 3 miles away. What do you do?",
        choices: [
          { text: "Go to school", effect: () => { 
            // Play school bell sound for the school choice
            setTimeout(() => playSound(sfxSchoolBell), 300);
          }, next: null, endMessage: "You went to school, but your family is limited tonight on what they can eat and drink. Education is important, but so is water. Maybe next time you can help both!" },
          { text: "🪣 Grab the yellow jerry can and start on your trail", effect: () => {
            // Play jerry can sound when grabbing it
            setTimeout(() => playSound(sfxJerrycan), 200);
          }, next: 1 }
        ]
      },
      {
        text: "You meet your friend Amina at the edge of the village. She offers to walk with you. What do you do?",
        choices: [
          { text: "Walk together", effect: () => { 
            wentAlone = false; 
            // Play children laughing sound for friendship choice
            setTimeout(() => playSound(sfxLaughter), 400);
          }, next: 2 },
          { text: "Go alone", effect: () => { 
            window.doublePointsThisStep = true; 
            wentAlone = true;
            // Play footsteps on dirt for going alone
            setTimeout(() => playSound(sfxWalk), 300);
          }, next: 2 }
        ]
      },
      {
        text: "There’s broken glass ahead. What do you do?",
        choices: [
          { text: "Step carefully around it", effect: () => {
            // Play cautious walking sound
            setTimeout(() => playSound(sfxWalk), 200);
          }, next: 3 },
          { text: "Run through it quickly", effect: () => {
            // Play breaking glass sound immediately - both audio element and enhanced fallback
            playSound(sfxGlassBreak);
            setTimeout(() => createEnhancedGlassBreak(), 100);
          }, next: 3, glassCutScene: true },
          { text: "Ask Amina for help", effect: () => { 
            window.broomCutScene = true;
            // Play sweep/clean sound for help with glass
            setTimeout(() => playSound(sfxThrow), 300);
          }, next: 3 }
        ]
      },
      {
        text: "A snake is coiled in the path. What do you do?",
        choices: [
          { text: "Walk around slowly", effect: () => { 
            window.snakeWalkAroundCutScene = true;
            // Play careful walking sound
            setTimeout(() => playSound(sfxWalk), 250);
          }, next: 4 },
          { text: "Throw a rock at it", effect: () => { 
            energy--;
            // Play throwing sound then enhanced snake hiss
            playSound(sfxThrow);
            setTimeout(() => playSound(sfxSnakeHiss), 400);
            setTimeout(() => createEnhancedSnakeHiss(), 500);
          }, next: 4 },
          { text: "Wait for it to leave", effect: () => { 
            energy = energy - 1; 
            window.skipJourneyPointsThisStep = true; 
            window.snakeWaitCutScene = true;
            // Play wind sound while waiting
            setTimeout(() => playSound(sfxWind), 300);
          }, next: 4 }
        ]
      },
      {
        text: "You reach a muddy patch. What do you do?",
        choices: [
          { text: "Rest for a moment", effect: () => { 
            energy = energy + 2; 
            window.muddyPatchRestCutScene = true;
            // Play rest sound and gentle birds
            setTimeout(() => playSound(sfxRest), 200);
            setTimeout(() => playSound(sfxBirds), 800);
          }, next: 5 },
          { text: "Push through", effect: () => { 
            energy = energy - 2; 
            window.muddyPatchPushThroughCutScene = true;
            // Play determined walking sound with splash
            setTimeout(() => playSound(sfxWalk), 100);
            setTimeout(() => playSound(sfxSplash), 500);
          }, next: 5 },
          { text: "Try to find another way around", effect: () => { showLostInBrushCutScene(); }, next: null }
        ]
      },
      {
        text: "You see a wild dog in the road. What do you do?",
        choices: [
          // If you stand your ground, just continue to the next step
          { text: "Stand your ground. Ignore the dog and keep walking past it.", effect: () => {
            // Play confident walking sound
            setTimeout(() => playSound(sfxWalk), 200);
          }, next: 6 },
          // If you distract the dog, set the flag for the cut scene (do not advance step here)
          { text: "Distract the dog by tossing something into the brush, then run past it yelling.", effect: () => { 
            window.wildDogCutScene = true;
            // Play throwing sound immediately then enhanced dog bark
            playSound(sfxThrow);
            setTimeout(() => playSound(sfxDogBark), 300);
            setTimeout(() => createEnhancedDogBark(), 400);
          }, next: null }
        ]
      },
      {
        text: "You finally reach the river! The water source is busy with other villagers. What do you do?",
        choices: [
          // Wait patiently in line
          { text: "Wait patiently in line with the other villagers", effect: () => { 
            energy = energy - 1;
            // Play crowd gathering sounds
            setTimeout(() => playSound(sfxCrowd), 300);
          }, next: 7 },
          { text: "Ask if you can help carry water for an elderly woman", effect: () => { 
            score += difficultySettings[currentDifficulty].pointsPerChoice * 2; 
            energy = energy - 1;
            // Play heartwarming community sound
            setTimeout(() => playSound(sfxCommunity), 200);
            setTimeout(() => playSound(sfxHeart), 600);
          }, next: 7 }
        ]
      },
      {
        text: "You made it to the water! Time to head home.",
        choices: [
          { text: "Finish the journey", effect: () => {
            // Play water filling sound
            setTimeout(() => playSound(sfxSplash), 200);
            setTimeout(() => playSound(sfxWaterSplash), 600);
          }, next: null }
        ]
      }
    ];

    // Array of background images for each scene
    // (You can replace these URLs with your own or other free images)
    const backgroundImages = [
      // Girl waking up - using custom image
      "img/girl waking up.png",
      // Meeting Amina - using custom image
      "img/girlreachinghand.png",
      // Broken glass scene - using custom image
      "img/girlwithbrokenglass.png",
      // Snake encounter - using custom image
      "img/girl with snake.png",
      // Muddy patch scene - using custom image
      "img/girlwithmud.png",
      // Wild dog encounter - using custom image
      "img/wild dog.jpg",
      // River/water source scene - using custom image
      "img/river.jpg"
    ];

    // Function to set the background image for the current step
    function setBackground(step) {
      // Get the game container element
      const gameContainer = document.getElementById('gameContainer');
      // If step is valid, set the background image
      if (backgroundImages[step]) {
        gameContainer.style.backgroundImage = `url('${backgroundImages[step]}')`;
      } else {
        // Default background if step is out of range
        gameContainer.style.backgroundImage = '';
      }
    }

    // Progressive journey positions for smooth character movement
    // Each story step gets its own position along the winding path
    const journeyPositions = [
      {cx:60, cy:80},    // Step 0: Home - wake up early
      {cx:90, cy:65},    // Step 1: Edge of village - meet Amina
      {cx:140, cy:50},   // Step 2: First obstacle - broken glass
      {cx:200, cy:60},   // Step 3: Snake encounter
      {cx:280, cy:85},   // Step 4: Muddy patch
      {cx:360, cy:45},   // Step 5: Wild dog encounter
      {cx:440, cy:20},   // Step 6: Approaching water source
      {cx:520, cy:55},   // Step 7: At the water source/river
      {cx:580, cy:70},   // Step 8: Starting journey back
      {cx:640, cy:50},   // Step 9: Halfway back
      {cx:700, cy:40},   // Step 10: Almost home
      {cx:740, cy:45}    // Step 11: Return to village (final)
    ];

    // Milestone positions for visual reference (not clickable)
    const milestonePositions = [
      {cx:60, cy:80},    // Home
      {cx:280, cy:85},   // Obstacles area
      {cx:520, cy:55},   // Water Source
      {cx:740, cy:45}    // Village
    ];

    // Move the character progressively along the path with each story step
    function moveCharacter(step) {
      // Use the step directly as an index into journeyPositions
      let positionIndex = Math.min(step, journeyPositions.length - 1);
      
      const character = document.getElementById('characterContainer');
      const pathSVG = document.getElementById('pathSVG');
      const svgRect = pathSVG.getBoundingClientRect();
      const scaleX = svgRect.width / 800;  // Updated for new viewBox width
      const scaleY = svgRect.height / 100;  // Updated for new viewBox height
      const left = journeyPositions[positionIndex].cx * scaleX - character.offsetWidth / 2;
      const top = journeyPositions[positionIndex].cy * scaleY - character.offsetHeight + 30; // 30px offset to align feet
      
      // Play movement sound
      playSound(sfxMovement);
      
      // Add smooth transition animation with slower speed for more gradual movement
      character.style.transition = 'left 1.2s ease-in-out, top 1.2s ease-in-out';
      character.style.left = `${left}px`;
      character.style.top = `${top}px`;
      
      // Update progress trail to show completed path up to current position
      updateProgressTrail(step);
      
      // Play milestone sound if reaching specific story milestones
      if (step === 2 || step === 4 || step === 7 || step === 11) {
        setTimeout(() => playSound(sfxMilestone), 1200);
      }
      
      // Add a small bounce effect when reaching the destination
      setTimeout(() => {
        character.style.transform = 'scale(1.1)';
        setTimeout(() => {
          character.style.transform = 'scale(1)';
        }, 200);
      }, 1200);  // Match the movement duration
    }

    // Milestones are now just visual markers (not interactive)
    function setupMilestoneMarkers() {
      // Milestones are purely visual - no hover effects or interactivity
      const milestones = document.querySelectorAll('.milestone');
      milestones.forEach((milestone) => {
        // Remove cursor pointer and any interactive styling
        milestone.style.cursor = 'default';
      });
    }

    // Update the progress trail to show completed path segments progressively
    function updateProgressTrail(step) {
      const progressTrail = document.getElementById('progressTrail');
      if (!progressTrail) return;
      
      // Create progressive path segments based on story step
      const progressivePathSegments = [
        "M 60 80", // Step 0: Start at home
        "M 60 80 Q 75 72 90 65", // Step 1: To edge of village
        "M 60 80 Q 75 72 90 65 Q 115 57 140 50", // Step 2: To first obstacle
        "M 60 80 Q 75 72 90 65 Q 115 57 140 50 Q 170 55 200 60", // Step 3: To snake area
        "M 60 80 Q 75 72 90 65 Q 115 57 140 50 Q 170 55 200 60 Q 240 72 280 85", // Step 4: To muddy patch
        "M 60 80 Q 75 72 90 65 Q 115 57 140 50 Q 170 55 200 60 Q 240 72 280 85 Q 320 65 360 45", // Step 5: To wild dog area
        "M 60 80 Q 75 72 90 65 Q 115 57 140 50 Q 170 55 200 60 Q 240 72 280 85 Q 320 65 360 45 Q 400 32 440 20", // Step 6: Approaching water
        "M 60 80 Q 75 72 90 65 Q 115 57 140 50 Q 170 55 200 60 Q 240 72 280 85 Q 320 65 360 45 Q 400 32 440 20 Q 480 37 520 55", // Step 7: At water source
        "M 60 80 Q 120 40 200 60 Q 280 85 360 45 Q 440 20 520 55 Q 550 62 580 70", // Step 8: Starting journey back
        "M 60 80 Q 120 40 200 60 Q 280 85 360 45 Q 440 20 520 55 Q 550 62 580 70 Q 610 60 640 50", // Step 9: Halfway back
        "M 60 80 Q 120 40 200 60 Q 280 85 360 45 Q 440 20 520 55 Q 550 62 580 70 Q 610 60 640 50 Q 670 45 700 40", // Step 10: Almost home
        "M 60 80 Q 120 40 200 60 Q 280 85 360 45 Q 440 20 520 55 Q 600 80 680 35 Q 720 20 740 45" // Step 11: Complete journey back to village
      ];
      
      // Ensure we don't exceed the array bounds
      const segmentIndex = Math.min(step, progressivePathSegments.length - 1);
      
      // Update the progress trail path
      progressTrail.setAttribute('d', progressivePathSegments[segmentIndex]);
      
      // Add a subtle glow effect to the completed trail
      if (segmentIndex > 0) {
        progressTrail.style.filter = 'drop-shadow(0 0 4px rgba(79, 203, 83, 0.6))';
      } else {
        progressTrail.style.filter = 'none';
      }
    }

    // Get audio elements
    // Ambient sounds (these are commented out in HTML, so they'll be null)
    const ambientWind = document.getElementById('ambientWind');
    const ambientFootsteps = document.getElementById('ambientFootsteps');
    const ambientWater = document.getElementById('ambientWater');
    
    // UI and interaction sounds
    const sfxClick = document.getElementById('sfxClick');
    const sfxButton = document.getElementById('sfxButton');
    const sfxVictory = document.getElementById('sfxVictory');
    const sfxLoss = document.getElementById('sfxLoss');
    
    // Journey progression sounds
    const sfxPointsEarned = document.getElementById('sfxPointsEarned');
    const sfxEnergyGain = document.getElementById('sfxEnergyGain');
    const sfxEnergyLoss = document.getElementById('sfxEnergyLoss');
    const sfxMovement = document.getElementById('sfxMovement');
    const sfxMilestone = document.getElementById('sfxMilestone');
    
    // Environmental and story sounds
    const sfxGlassBreak = document.getElementById('sfxGlassBreak');
    const sfxSnakeHiss = document.getElementById('sfxSnakeHiss');
    const sfxDogBark = document.getElementById('sfxDogBark');
    const sfxWaterSplash = document.getElementById('sfxWaterSplash');
    const sfxCommunity = document.getElementById('sfxCommunity');
    
    // Educational and notification sounds
    const sfxFactAlert = document.getElementById('sfxFactAlert');
    const sfxWarning = document.getElementById('sfxWarning');

    // Additional environmental and action sounds
    const sfxWalk = document.getElementById('sfxWalk');
    const sfxRest = document.getElementById('sfxRest');
    const sfxThrow = document.getElementById('sfxThrow');
    const sfxSplash = document.getElementById('sfxSplash');
    const sfxCrowd = document.getElementById('sfxCrowd');
    const sfxBirds = document.getElementById('sfxBirds');
    const sfxWind = document.getElementById('sfxWind');
    const sfxJerrycan = document.getElementById('sfxJerrycan');
    const sfxSchoolBell = document.getElementById('sfxSchoolBell');
    const sfxGasp = document.getElementById('sfxGasp');
    const sfxHeart = document.getElementById('sfxHeart');
    const sfxLaughter = document.getElementById('sfxLaughter');

    // Additional immersive sound effects
    const sfxMorning = document.getElementById('sfxMorning');
    const sfxVillage = document.getElementById('sfxVillage');
    const sfxRiver = document.getElementById('sfxRiver');
    const sfxCelebration = document.getElementById('sfxCelebration');
    const sfxFriendship = document.getElementById('sfxFriendship');

    // Helper to play a sound from the start
    function playSound(audio) {
      // Ensure Web Audio context is initialized
      initializeAudioContext();
      
      if (audio && audio.id) {
        console.log('Attempting to play:', audio.id);
        
        // Try to play the actual audio element first, but use very short timeout
        let soundPlayedSuccessfully = false;
        
        try {
          audio.currentTime = 0;
          const playPromise = audio.play();
          if (playPromise !== undefined) {
            playPromise.then(() => {
              console.log('Successfully played:', audio.id);
              soundPlayedSuccessfully = true;
            }).catch(e => {
              console.log('Audio element failed for:', audio.id, '- using Web Audio fallback');
              if (!soundPlayedSuccessfully) {
                playWebAudioFallback(audio.id);
              }
            });
          }
        } catch (e) {
          console.log('Audio element error for:', audio.id, '- using Web Audio fallback');
          playWebAudioFallback(audio.id);
        }
        
        // Use Web Audio as primary fallback after very short delay
        setTimeout(() => {
          if (!soundPlayedSuccessfully) {
            console.log('Using Web Audio fallback for:', audio.id);
            playWebAudioFallback(audio.id);
          }
        }, 50);
      } else {
        console.log('Audio element not found - using Web Audio fallback');
        playWebAudioFallback('default');
      }
    }

    // Initialize Web Audio context on first user interaction
    let audioContextInitialized = false;
    function initializeAudioContext() {
      if (!audioContextInitialized) {
        try {
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();
          if (audioContext.state === 'suspended') {
            audioContext.resume();
          }
          audioContextInitialized = true;
          console.log('Web Audio API initialized');
        } catch (e) {
          console.log('Web Audio API not available');
        }
      }
    }

    // Enhanced Web Audio fallback with specific sounds for each type
    function playWebAudioFallback(audioId) {
      console.log('Playing Web Audio fallback for:', audioId);
      
      // Make sure we have a valid audioId string
      const id = audioId || 'default';
      
      if (id.includes('Victory') || id.includes('Celebration')) {
        createSpecialBeep('victory');
      } else if (id.includes('Loss') || id.includes('Warning')) {
        createSpecialBeep('loss');
      } else if (id.includes('Points') || id.includes('Milestone')) {
        createSpecialBeep('points');
      } else if (id.includes('Energy')) {
        if (id.includes('Gain')) {
          createSimpleBeep(440, 150); // Ascending for gain
          setTimeout(() => createSimpleBeep(523, 100), 100);
        } else {
          createSimpleBeep(330, 200); // Descending for loss
          setTimeout(() => createSimpleBeep(293, 150), 120);
        }
      } else if (id.includes('Movement') || id.includes('Walk')) {
        // Create footstep rhythm - two distinct steps
        createSimpleBeep(200, 60);
        setTimeout(() => createSimpleBeep(180, 60), 200);
        setTimeout(() => createSimpleBeep(200, 60), 400);
        setTimeout(() => createSimpleBeep(180, 60), 600);
      } else if (id.includes('Water') || id.includes('Splash') || id.includes('River')) {
        // Water sounds - bubbly multiple quick beeps
        for (let i = 0; i < 6; i++) {
          setTimeout(() => createSimpleBeep(300 + (Math.random() * 100), 40), i * 30);
        }
      } else if (id.includes('Wind')) {
        // Wind sound - enhanced low oscillating tone
        createEnhancedWindSound();
      } else if (id.includes('Birds')) {
        // Bird sounds - more realistic chirping sequence
        createEnhancedBirdSound();
      } else if (id.includes('Snake')) {
        // Enhanced snake hiss - realistic hissing sound
        createEnhancedSnakeHiss();
      } else if (id.includes('Dog')) {
        // Enhanced dog bark - realistic bark pattern
        createEnhancedDogBark();
      } else if (id.includes('Glass')) {
        // Enhanced glass break - realistic shattering sound
        createEnhancedGlassBreak();
      } else if (id.includes('Button') || id.includes('Click')) {
        createSimpleBeep(440, 50);
      } else if (id.includes('Heart')) {
        // Heartbeat - realistic rhythm
        createSimpleBeep(220, 80);
        setTimeout(() => createSimpleBeep(240, 60), 100);
        setTimeout(() => createSimpleBeep(220, 80), 600);
        setTimeout(() => createSimpleBeep(240, 60), 700);
      } else if (id.includes('Laughter')) {
        // Laughter - more expressive ascending notes
        const notes = [400, 450, 500, 480, 520];
        notes.forEach((note, i) => {
          setTimeout(() => createSimpleBeep(note, 100), i * 120);
        });
      } else if (id.includes('Crowd') || id.includes('Community')) {
        // Crowd sounds - overlapping voices simulation
        for (let i = 0; i < 4; i++) {
          setTimeout(() => createSimpleBeep(300 + (i * 30), 150), i * 80);
        }
      } else if (id.includes('Rest')) {
        // Gentle restful sound
        createSimpleBeep(392, 200);
        setTimeout(() => createSimpleBeep(349, 300), 150);
      } else if (id.includes('Throw')) {
        // Throwing whoosh sound
        createSimpleBeep(600, 50);
        setTimeout(() => createSimpleBeep(400, 100), 50);
        setTimeout(() => createSimpleBeep(200, 150), 100);
      } else {
        createSimpleBeep(349, 150); // Default sound
      }
    }

    // Create enhanced wind sound effect
    function createEnhancedWindSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        const filter = audioContext.createBiquadFilter();
        
        oscillator.connect(filter);
        filter.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // More realistic wind with frequency modulation
        oscillator.frequency.setValueAtTime(80, audioContext.currentTime);
        oscillator.frequency.linearRampToValueAtTime(120, audioContext.currentTime + 0.5);
        oscillator.frequency.linearRampToValueAtTime(90, audioContext.currentTime + 1);
        oscillator.frequency.linearRampToValueAtTime(110, audioContext.currentTime + 1.5);
        oscillator.type = 'sawtooth';
        
        filter.type = 'lowpass';
        filter.frequency.setValueAtTime(200, audioContext.currentTime);
        filter.Q.setValueAtTime(0.5, audioContext.currentTime);
        
        // More natural wind envelope
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.03, audioContext.currentTime + 0.2);
        gainNode.gain.linearRampToValueAtTime(0.06, audioContext.currentTime + 0.8);
        gainNode.gain.linearRampToValueAtTime(0.02, audioContext.currentTime + 1.2);
        gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 1.8);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 1.8);
      } catch (e) {
        console.log('Enhanced wind sound failed, using simple beep');
        createSimpleBeep(100, 500);
      }
    }

    // Create enhanced bird sound effect
    function createEnhancedBirdSound() {
      // Create multiple bird chirps with different frequencies and timing
      const birdSequences = [
        { freq: 1200, duration: 80, delay: 0 },
        { freq: 1000, duration: 60, delay: 100 },
        { freq: 1400, duration: 70, delay: 200 },
        { freq: 900, duration: 90, delay: 350 },
        { freq: 1100, duration: 50, delay: 500 },
        { freq: 1300, duration: 80, delay: 650 }
      ];
      
      birdSequences.forEach(bird => {
        setTimeout(() => {
          try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Create chirp-like frequency modulation
            oscillator.frequency.setValueAtTime(bird.freq, audioContext.currentTime);
            oscillator.frequency.linearRampToValueAtTime(bird.freq * 1.3, audioContext.currentTime + bird.duration / 3000);
            oscillator.frequency.linearRampToValueAtTime(bird.freq * 0.8, audioContext.currentTime + bird.duration / 1000);
            oscillator.type = 'sine';
            
            // Quick attack, fast decay for chirp effect
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.08, audioContext.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + bird.duration / 1000);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + bird.duration / 1000);
          } catch (e) {
            createSimpleBeep(bird.freq, bird.duration);
          }
        }, bird.delay);
      });
    }

    // Create enhanced snake hiss sound
    function createEnhancedSnakeHiss() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // Create white noise for hiss base
        const bufferSize = audioContext.sampleRate * 1.2; // 1.2 seconds
        const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
        const output = buffer.getChannelData(0);
        
        // Generate noise with specific characteristics for snake hiss
        for (let i = 0; i < bufferSize; i++) {
          output[i] = (Math.random() * 2 - 1) * 0.5;
        }
        
        const whiteNoise = audioContext.createBufferSource();
        whiteNoise.buffer = buffer;
        
        // Band-pass filter to create hiss frequency range
        const filter = audioContext.createBiquadFilter();
        filter.type = 'bandpass';
        filter.frequency.setValueAtTime(4000, audioContext.currentTime); // High frequency hiss
        filter.Q.setValueAtTime(1.5, audioContext.currentTime);
        
        // Second filter for more realistic snake hiss
        const filter2 = audioContext.createBiquadFilter();
        filter2.type = 'highpass';
        filter2.frequency.setValueAtTime(2000, audioContext.currentTime);
        
        const gainNode = audioContext.createGain();
        
        // Connect the chain
        whiteNoise.connect(filter);
        filter.connect(filter2);
        filter2.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // Envelope for realistic hiss
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.15, audioContext.currentTime + 0.1);
        gainNode.gain.linearRampToValueAtTime(0.12, audioContext.currentTime + 0.6);
        gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 1.2);
        
        whiteNoise.start(audioContext.currentTime);
        whiteNoise.stop(audioContext.currentTime + 1.2);
        
        console.log('Enhanced snake hiss created');
      } catch (e) {
        console.log('Enhanced snake hiss failed, using fallback');
        createNoiseSound(3000, 800);
      }
    }

    // Create enhanced dog bark sound
    function createEnhancedDogBark() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // Create multiple bark components
        const barkSounds = [
          { freq: 150, duration: 0.15, delay: 0 },      // First bark - low
          { freq: 200, duration: 0.12, delay: 0.02 },   // Bark harmonic
          { freq: 300, duration: 0.1, delay: 0.05 },    // Higher harmonic
          { freq: 180, duration: 0.2, delay: 0.4 },     // Second bark
          { freq: 220, duration: 0.15, delay: 0.42 },   // Second bark harmonic
        ];
        
        barkSounds.forEach(bark => {
          setTimeout(() => {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            const filter = audioContext.createBiquadFilter();
            
            oscillator.connect(filter);
            filter.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Use sawtooth for more aggressive bark sound
            oscillator.type = 'sawtooth';
            oscillator.frequency.setValueAtTime(bark.freq, audioContext.currentTime);
            
            // Add some frequency modulation for realism
            oscillator.frequency.linearRampToValueAtTime(bark.freq * 1.2, audioContext.currentTime + bark.duration * 0.3);
            oscillator.frequency.linearRampToValueAtTime(bark.freq * 0.8, audioContext.currentTime + bark.duration);
            
            // Low-pass filter to soften the sound
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(800, audioContext.currentTime);
            
            // Sharp attack, quick decay for bark effect
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + bark.duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + bark.duration);
          }, bark.delay * 1000);
        });
        
        console.log('Enhanced dog bark created');
      } catch (e) {
        console.log('Enhanced dog bark failed, using fallback');
        createSimpleBeep(180, 150);
        setTimeout(() => createSimpleBeep(220, 120), 100);
        setTimeout(() => createSimpleBeep(180, 180), 400);
      }
    }

    // Create enhanced glass breaking sound
    function createEnhancedGlassBreak() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // Create multiple glass breaking components
        const glassComponents = [
          { type: 'initial', freq: 2000, duration: 0.1, delay: 0 },     // Initial impact
          { type: 'shatter', freq: 1500, duration: 0.2, delay: 0.05 },  // Main shatter
          { type: 'shatter', freq: 1800, duration: 0.15, delay: 0.1 },  // Secondary shatter
          { type: 'tinkle', freq: 3000, duration: 0.3, delay: 0.2 },    // High tinkles
          { type: 'tinkle', freq: 2500, duration: 0.25, delay: 0.25 },  // More tinkles
          { type: 'tinkle', freq: 3500, duration: 0.2, delay: 0.3 },    // Final tinkles
        ];
        
        glassComponents.forEach(glass => {
          setTimeout(() => {
            if (glass.type === 'initial' || glass.type === 'shatter') {
              // Use noise for shattering sound
              const bufferSize = audioContext.sampleRate * glass.duration;
              const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
              const output = buffer.getChannelData(0);
              
              for (let i = 0; i < bufferSize; i++) {
                output[i] = (Math.random() * 2 - 1) * 0.7;
              }
              
              const whiteNoise = audioContext.createBufferSource();
              whiteNoise.buffer = buffer;
              
              const filter = audioContext.createBiquadFilter();
              filter.type = 'bandpass';
              filter.frequency.setValueAtTime(glass.freq, audioContext.currentTime);
              filter.Q.setValueAtTime(2, audioContext.currentTime);
              
              const gainNode = audioContext.createGain();
              
              whiteNoise.connect(filter);
              filter.connect(gainNode);
              gainNode.connect(audioContext.destination);
              
              gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + glass.duration);
              
              whiteNoise.start(audioContext.currentTime);
              whiteNoise.stop(audioContext.currentTime + glass.duration);
            } else {
              // Use oscillator for tinkle sounds
              const oscillator = audioContext.createOscillator();
              const gainNode = audioContext.createGain();
              
              oscillator.connect(gainNode);
              gainNode.connect(audioContext.destination);
              
              oscillator.type = 'sine';
              oscillator.frequency.setValueAtTime(glass.freq, audioContext.currentTime);
              oscillator.frequency.exponentialRampToValueAtTime(glass.freq * 0.5, audioContext.currentTime + glass.duration);
              
              gainNode.gain.setValueAtTime(0, audioContext.currentTime);
              gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
              gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + glass.duration);
              
              oscillator.start(audioContext.currentTime);
              oscillator.stop(audioContext.currentTime + glass.duration);
            }
          }, glass.delay * 1000);
        });
        
        console.log('Enhanced glass break created');
      } catch (e) {
        console.log('Enhanced glass break failed, using fallback');
        createNoiseSound(2000, 200);
        setTimeout(() => createSimpleBeep(1500, 150), 100);
        setTimeout(() => createSimpleBeep(3000, 200), 200);
        setTimeout(() => createSimpleBeep(2500, 100), 350);
      }
    }

    // Create wind sound effect (keeping original for backward compatibility)
    function createWindSound() {
      createEnhancedWindSound();
    }

    // Create bird sound effect (keeping original for backward compatibility)  
    function createBirdSound() {
      createEnhancedBirdSound();
    }

    // Create noise-based sound effect
    function createNoiseSound(baseFreq, duration) {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const bufferSize = audioContext.sampleRate * (duration / 1000);
        const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
        const output = buffer.getChannelData(0);
        
        for (let i = 0; i < bufferSize; i++) {
          output[i] = Math.random() * 2 - 1;
        }
        
        const whiteNoise = audioContext.createBufferSource();
        whiteNoise.buffer = buffer;
        
        const filter = audioContext.createBiquadFilter();
        filter.type = 'bandpass';
        filter.frequency.setValueAtTime(baseFreq, audioContext.currentTime);
        
        const gainNode = audioContext.createGain();
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration / 1000);
        
        whiteNoise.connect(filter);
        filter.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        whiteNoise.start(audioContext.currentTime);
        whiteNoise.stop(audioContext.currentTime + duration / 1000);
      } catch (e) {
        console.log('Noise sound failed, using simple beep');
        createSimpleBeep(baseFreq, duration);
      }
    }

    // Create a simple beep sound using Web Audio API as fallback
    function createSimpleBeep(frequency = 440, duration = 200) {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
        oscillator.type = 'sine';
        
        // Create a more pleasant sound envelope
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration / 1000);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + duration / 1000);
        
        console.log(`Created beep: ${frequency}Hz for ${duration}ms`);
      } catch (e) {
        console.log('Web Audio API not available');
      }
    }

    // Create complex beep for special events
    function createSpecialBeep(type) {
      if (type === 'victory') {
        // Play ascending notes for victory
        createSimpleBeep(523, 150); // C
        setTimeout(() => createSimpleBeep(659, 150), 100); // E
        setTimeout(() => createSimpleBeep(784, 300), 200); // G
      } else if (type === 'loss') {
        // Play descending notes for loss
        createSimpleBeep(440, 200); // A
        setTimeout(() => createSimpleBeep(370, 200), 150); // F#
        setTimeout(() => createSimpleBeep(330, 400), 300); // E
      } else if (type === 'points') {
        // Play quick ascending beep for points
        createSimpleBeep(440, 100);
        setTimeout(() => createSimpleBeep(523, 100), 80);
      }
    }

    // Helper to play ambient sounds with volume control
    function playAmbient(audio, volume = 0.3) {
      if (audio) {
        audio.volume = volume;
        audio.play().catch(e => console.log('Ambient audio play failed:', e));
      }
    }

    // Helper to stop ambient sounds
    function stopAmbient(audio) {
      if (audio) {
        audio.pause();
        audio.currentTime = 0;
      }
    }

    // Helper to change energy with sound feedback
    function changeEnergy(amount) {
      const previousEnergy = energy;
      energy += amount;
      
      // Play appropriate sound based on energy change
      if (amount > 0) {
        playSound(sfxEnergyGain);
      } else if (amount < 0) {
        playSound(sfxEnergyLoss);
      }
      
      // Show visual feedback if energy hits critical levels
      if (energy <= 1 && previousEnergy > 1) {
        playSound(sfxWarning);
      }
      
      return energy;
    }

    // Show a directions cut scene at the start of the game (now with two screens)
    function showDirectionsCutScene() {
      // Remove any previous overlay if present
      let oldOverlay = document.getElementById('directionsCutScene');
      if (oldOverlay) oldOverlay.remove();

      // Create a new overlay div
      const overlay = document.createElement('div');
      overlay.id = 'directionsCutScene';
      overlay.style.position = 'absolute';
      overlay.style.left = '0';
      overlay.style.top = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.background = 'rgba(255,255,255,0.97)';
      overlay.style.display = 'flex';
      overlay.style.flexDirection = 'column';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.zIndex = '30';
      overlay.style.textAlign = 'center';

      // First screen: introduction
      overlay.innerHTML = `
        <div style="padding: 20px; max-width: 500px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; align-items: center; text-align: center;">
          <img src="img/Girl with jerry can.jpg" alt="Young girl carrying a large yellow water container, representing millions of girls who walk long distances daily to collect water for their families" style="width: 100%; max-width: 140px; height: auto; border-radius: 10px; border: 2px solid #FFC907; margin-bottom: 15px;">
          <div id="directionsIntro" style="font-size:1.1em; color:#005073; font-weight:bold; margin-bottom:18px; max-width:420px; line-height: 1.4;">
            <span style="font-size:1.3em;">Welcome to The Long Walk: A Journey for Water</span><br><br>
            This story is based on the true journeys of girls in countries like Ethiopia, Uganda, and India.<br><br>
            Today, you will follow <span style='color:#4FCB53;'>Amina</span> as she walks miles to collect water for her family.<br><br>
            <span style='color:#F5402C;'>Your choices will affect what happens to Amina and her village.</span><br><br>
          </div>
          <button id="nextDirectionsBtn" class="choiceBtn" style="max-width:220px; margin-top: 10px;" aria-label="Continue to game instructions">Next</button>
        </div>
      `;
      document.getElementById('gameContainer').appendChild(overlay);

      // When 'Next' is clicked, show the instructions screen
      document.getElementById('nextDirectionsBtn').onclick = function() {
        // Replace the content with instructions
        overlay.innerHTML = `
          <div style="padding: 20px; max-width: 500px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; align-items: center; text-align: center;">
            <img src="img/clean and dirty water cups.jpg" alt="Two cups side by side showing the contrast between clean, clear drinking water and dirty, contaminated water with visible particles and debris" style="width: 100%; max-width: 160px; height: auto; border-radius: 8px; border: 2px solid #2E9DF7; margin-bottom: 12px;">
            <div id="directionsInstructions" style="font-size:1.0em; color:#005073; font-weight:bold; margin-bottom:18px; max-width:420px; line-height: 1.4;">
              <div style="background: rgba(255,201,7,0.2); padding: 8px; border-radius: 6px; margin-bottom: 12px;">
                <strong>${difficultySettings[currentDifficulty].name} Mode:</strong><br>
                ${difficultySettings[currentDifficulty].description}
              </div>
              <span style='color:#2E9DF7;'>Journey Points:</span> Make good choices to earn points and help the village get a new well!<br><br>
              <span style='color:#159A48;'>Energy:</span> You start with <b>${difficultySettings[currentDifficulty].startingEnergy} Energy</b>. If you lose all your energy, Amina must turn back and her family won't get water that day.<br><br>
              The more people play and help Amina, the more is donated to <a href='https://www.charitywater.org/' target='_blank' style='color:#2E9DF7;' aria-label="Visit charity: water website to learn more and donate">Charity: Water</a>.<br><br>
              <span style='color:#FFC907;'>Are you ready to help Amina on her journey?</span>
            </div>
            <img src="img/water-can.png" alt="Yellow plastic water container used for collecting and carrying water during the long journey to water sources" style="width: 100%; max-width: 70px; height: auto; margin-bottom: 12px;">
            <button id="startJourneyBtn" class="choiceBtn" style="max-width:220px; background-color:#4FCB53; border-color:#FFC907; margin-top: 10px;" aria-label="Start Amina's water collection journey">Start Journey</button>
          </div>
        `;
        // When 'Start Journey' is clicked, remove overlay and start the story
        document.getElementById('startJourneyBtn').onclick = function() {
          overlay.remove();
          updateDifficultyDisplay();
          // Play morning awakening sound to start the journey
          setTimeout(() => playSound(sfxMorning), 200);
          // Show an opening fact to set the educational tone
          showSpecificFact("Every day, 200 million women and girls spend hours walking to collect water. Today, you'll experience their journey.");
          showStep();
        };
      };
    }

    // Start ambient sounds when game starts
    function startGame() {
      // Get selected difficulty
      const selectedDifficulty = document.querySelector('input[name="difficulty"]:checked');
      if (selectedDifficulty) {
        currentDifficulty = selectedDifficulty.value;
      }
      
      currentStep = 0;
      energy = difficultySettings[currentDifficulty].startingEnergy;
      score = 0; // Reset Journey Points to 0
      lastScore = 0;
      returning = false; // Reset return flag
      
      // Update UI to reflect selected difficulty
      updateDifficultyDisplay();
      setBackground(currentStep);
      moveCharacter(currentStep);
      choicesContainer.innerHTML = '';
      // Hide the well scene if it exists
      hideWellScene();
      // Setup milestone markers as visual indicators only
      setupMilestoneMarkers();
      
      // NO ambient sounds playing automatically - only interactive sounds when triggered
      
      // Show the directions cut scene first
      showDirectionsCutScene();
    }

    // Update difficulty display in UI
    function updateDifficultyDisplay() {
      const difficultyDisplay = document.getElementById('difficultyDisplay');
      const scoreValue = document.getElementById('scoreValue');
      const goalValue = document.getElementById('goalValue');
      
      if (difficultyDisplay) {
        difficultyDisplay.textContent = `${difficultySettings[currentDifficulty].name} Mode`;
      }
      if (scoreValue) {
        scoreValue.textContent = score;
      }
      if (goalValue) {
        goalValue.textContent = difficultySettings[currentDifficulty].winCondition;
      }
    }

    // Stop all ambient sounds
    function stopAmbient() {
      // Stop individual ambient sounds if they exist
      if (ambientWind) {
        ambientWind.pause();
        ambientWind.currentTime = 0;
      }
      if (ambientFootsteps) {
        ambientFootsteps.pause(); 
        ambientFootsteps.currentTime = 0;
      }
      if (ambientWater) {
        ambientWater.pause();
        ambientWater.currentTime = 0;
      }
    }

    // Array of "Did You Know?" facts - expanded for better educational content
    const didYouKnowFacts = [
      // Water crisis facts
      "1 in 10 people worldwide lack access to clean water - that's 771 million people!",
      "2 billion people don't have safely managed drinking water at home.",
      "Girls in sub-Saharan Africa spend 4x more time fetching water than boys.",
      "Women and girls spend 200 million hours every day collecting water.",
      "Access to clean water means more time for school and play.",
      "Diseases from dirty water kill more people every year than all forms of violence, including war.",
      "Every 2 minutes, a child dies from a water-related disease.",
      "A person can live about a month without food, but only about a week without water.",
      
      // Journey and impact facts
      "Many girls walk up to 6 hours every day just to collect water for their families.",
      "The water collected is often contaminated and makes people sick.",
      "When communities get clean water, girls' school attendance increases by 15%.",
      "Clean water reduces childhood mortality by up to 50%.",
      "Access to clean water can increase family income by up to 20%.",
      "One clean water project can serve an entire village for 20+ years.",
      
      // charity: water specific facts
      "charity: water has funded over 111,000 water projects around the world.",
      "Thanks to charity: water, more than 15 million people now have clean water.",
      "100% of public donations to charity: water go directly to clean water projects.",
      "charity: water works in 29 countries to help people get safe water.",
      "Clean water from charity: water projects helps kids spend more time in school.",
      "charity: water uses GPS and photos to track every project they fund.",
      "Since 2006, charity: water has raised over $740 million for clean water projects.",
      
      // Solutions and hope
      "Just $30 can provide one person with clean water for life.",
      "Building a well costs about the same as a small car but serves hundreds of people.",
      "Solar-powered water systems work even in remote areas without electricity.",
      "Community training ensures water projects last for decades.",
      "When girls don't have to walk for water, they can go to school and become leaders.",
      "Learn more inspiring stories at <a href='https://www.charitywater.org/stories' target='_blank'>charitywater.org/stories</a>."
    ];

    // Show a random Did You Know box after each decision
    function showDidYouKnow() {
      const box = document.getElementById('didYouKnow');
      // Pick a random fact except the last one (save last for ending)
      const factIndex = Math.floor(Math.random() * (didYouKnowFacts.length - 1));
      box.innerHTML = `<strong>Did You Know?</strong> ${didYouKnowFacts[factIndex]}`;
      box.style.display = 'block';
      box.style.opacity = '1';
      
      // Play educational fact alert sound
      playSound(sfxFactAlert);
      
      // Show the fact for difficulty-based time
      const displayTime = difficultySettings[currentDifficulty].factDisplayTime;
      setTimeout(() => {
        box.style.opacity = '0';
        setTimeout(() => { box.style.display = 'none'; }, 500);
      }, displayTime);
    }

    // Show a specific Did You Know fact (for cut scenes)
    function showSpecificFact(factText, displayTimeMs = null) {
      const box = document.getElementById('didYouKnow');
      box.innerHTML = `<strong>Did You Know?</strong> ${factText}`;
      box.style.display = 'block';
      box.style.opacity = '1';
      // Use custom display time or default to difficulty setting
      const displayTime = displayTimeMs || difficultySettings[currentDifficulty].factDisplayTime;
      setTimeout(() => {
        box.style.opacity = '0';
        setTimeout(() => { box.style.display = 'none'; }, 500);
      }, displayTime);
    }

    function updateScoreDisplay() {
      const scoreValue = document.getElementById('scoreValue');
      const goalValue = document.getElementById('goalValue');
      if (!scoreValue) return;
      
      scoreValue.textContent = score;
      if (goalValue) {
        goalValue.textContent = difficultySettings[currentDifficulty].winCondition;
      }
      
      // Show feedback if score changed
      if (score !== lastScore) {
        const diff = score - lastScore;
        const feedback = document.createElement('span');
        feedback.textContent = diff > 0 ? ` +${diff}` : ` ${diff}`;
        feedback.style.color = diff > 0 ? "#4FCB53" : "#F5402C";
        feedback.style.fontWeight = "bold";
        feedback.style.marginLeft = "8px";
        scoreValue.parentElement.appendChild(feedback);
        
        // Play sound based on score change
        if (diff > 0) {
          playSound(sfxPointsEarned);
        }
        
        setTimeout(() => feedback.remove(), 1200);
        lastScore = score;
      }
    }

    // Helper function to check if energy is 0 or less and end the game
    function checkGameOver() {
      // If energy is 0 or less, show the Game Over cut scene right away
      if (energy <= 0) {
        endGame();
        return true; // Game is over
      }
      return false; // Game continues
    }

    // In showStep, always add 2 journey points per step, or 4 if double points
    function showStep() {
      // Check for the muddy patch rest cut scene FIRST
      if (window.muddyPatchRestCutScene) {
        showMuddyPatchRestCutScene(() => {
          window.muddyPatchRestCutScene = false;
          // After the cut scene, check if energy is 0 or less
          if (energy <= 0) {
            endGame();
            return;
          }
          // Go to the next step after muddy patch (step 5: boys playing soccer)
          currentStep = 5;
          showStep(); // Call showStep() to continue the game
          showDidYouKnow();
        });
        return;
      }
      // Check for the muddy patch push through cut scene FIRST
      if (window.muddyPatchPushThroughCutScene) {
        showMuddyPatchPushThroughCutScene(() => {
          window.muddyPatchPushThroughCutScene = false;
          // After the cut scene, check if energy is 0 or less
          if (energy <= 0) {
            endGame();
            return;
          }
          // Go to the next step after muddy patch (step 5: boys playing soccer)
          currentStep = 5;
          showStep(); // Call showStep() to continue the game
          showDidYouKnow();
        });
        return;
      }
      // Always check if energy is 0 or less before doing anything else
      // If so, show the Game Over cut scene and stop the game
      if (checkGameOver()) {
        return;
      }
      // Set the background for the current step
      setBackground(currentStep);
      // Move the character and marker to match the story's progress on the map
      moveCharacter(currentStep);

      // If the game is over, show the ending
      if (
        currentStep >= storySteps.length ||
        energy <= 0 ||
        storySteps[currentStep].choices.every(choice => choice.next === null)
      ) {
        // If the ending is from a choice with a custom endMessage, show it
        const lastStep = storySteps[currentStep] || {};
        const chosen = lastStep.choices && lastStep.choices.find(c => c.next === null && c.endMessage);
        if (chosen && chosen.endMessage) {
          // Show a gentle overlay scene for the 'Go to school' ending
          showSchoolEndingScene(chosen.endMessage);
          // Stop the game here so it does not continue
          return;
        }
        endGame();
        return;
      }

      // Special logic: If player went alone, hide 'Ask Amina for help' in the glass step
      let step = storySteps[currentStep];
      let choicesToShow = step.choices;
      // If this is the glass step and player went alone, filter out the help option
      if (step.text.includes("broken glass") && wentAlone) {
        choicesToShow = step.choices.filter(choice => !choice.text.includes("Amina"));
      }
      // Play contextual sounds based on the story step
      if (step.text.includes("snake")) {
        setTimeout(() => playSound(sfxSnakeHiss), 200);
        setTimeout(() => playWebAudioFallback('sfxSnakeHiss'), 300); // Ensure snake sound plays
      } else if (step.text.includes("river") || step.text.includes("water")) {
        setTimeout(() => playSound(sfxWaterSplash), 200);
      } else if (step.text.includes("wild dog")) {
        setTimeout(() => playSound(sfxDogBark), 200);
        setTimeout(() => playWebAudioFallback('sfxDogBark'), 300); // Ensure dog bark plays
      } else if (step.text.includes("broken glass")) {
        setTimeout(() => playSound(sfxGlassBreak), 200);
        setTimeout(() => playWebAudioFallback('sfxGlassBreak'), 300); // Ensure glass sound plays
      }
      
      // Add more ambient contextual sounds based on story content
      if (step.text.includes("wake up early")) {
        // Morning sounds - birds chirping
        setTimeout(() => playSound(sfxBirds), 500);
      } else if (step.text.includes("meet your friend Amina")) {
        // Village friendship sounds
        setTimeout(() => playSound(sfxVillage), 300);
        setTimeout(() => playSound(sfxFriendship), 800);
      } else if (step.text.includes("muddy patch")) {
        // Wind sounds for outdoor challenge
        setTimeout(() => playSound(sfxWind), 400);
      } else if (step.text.includes("water source is busy")) {
        // Community gathering sounds
        setTimeout(() => playSound(sfxCrowd), 300);
        setTimeout(() => playSound(sfxRiver), 700);
      } else if (step.text.includes("made it to the water")) {
        // Victory moment with water splash and river sounds
        setTimeout(() => playSound(sfxRiver), 200);
        setTimeout(() => playSound(sfxWaterSplash), 600);
        setTimeout(() => playSound(sfxCelebration), 1000);
      }
      
      storyText.textContent = step.text;
      storyText.focus();
      choicesContainer.innerHTML = '';

      // Show choices for this step
      choicesToShow.forEach((choice, idx) => {
        const btn = document.createElement('button');
        btn.classList.add('choiceBtn');
        btn.textContent = choice.text;
        btn.setAttribute('aria-label', `Choice ${idx + 1}: ${choice.text}`);
        btn.setAttribute('tabindex', '0');
        
        // Add keyboard navigation
        btn.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            btn.click();
          }
        });
        btn.onclick = () => {
          // Initialize audio context on first user interaction
          initializeAudioContext();
          
          playSound(sfxButton); // Play button sound
          // If this is the 'Go alone' choice, show the cut scene and double points
          if (step.text.includes("Amina") && choice.text.includes("Go alone")) {
            showGoAloneScene(() => {
              choice.effect(); // Set doublePointsThisStep and wentAlone
              // Always add double journey points for this special choice
              score += difficultySettings[currentDifficulty].pointsPerChoice * 2;
              if (typeof choice.next === "number") {
                currentStep = choice.next;
              } else {
                currentStep++;
              }
              showStep();
              showDidYouKnow();
            });
            return;
          }
          choice.effect();
          // --- Fix for wild dog cut scene: if the flag is set, show the cut scene and return immediately ---
          if (window.wildDogCutScene) {
            // After the wild dog cut scene, subtract 2 energy. If energy is now 0 or less, show game over. Otherwise, go to the next step.
            showWildDogCutScene(() => {
              window.wildDogCutScene = false;
              energy = energy - difficultySettings[currentDifficulty].energyPenalty * 2; // Lose double energy for running past the dog
              if (energy <= 0) {
                // If energy is 0 or less, show the game over cut scene
                endGame();
                return;
              }
              currentStep++; // Go to the next step
              showStep();
              showDidYouKnow();
            });
            return;
          }
          // If this is the snake step and player throws a rock, show the snake bite scene and end the game
          if (step.text.includes("snake") && choice.text.includes("Throw a rock")) {
            showSnakeBiteScene(() => {
              energy = 0;
              endGame();
            });
            return;
          }
          // If this choice ends the game, show the overlay and stop
          if (choice.endMessage) {
            showSchoolEndingScene(choice.endMessage);
            return;
          }
          // If this choice triggers the glass cut scene, show it and stop
          if (choice.glassCutScene) {
            showGlassCutScene(() => {
              // Do NOT add journey points for this step, just move to next
              if (typeof choice.next === "number") {
                currentStep = choice.next;
              } else {
                currentStep++;
              }
              showStep();
              showDidYouKnow();
            });
            return;
          }
          // If this choice triggers the broom cut scene, show it and stop
          if (window.broomCutScene) {
            showBroomCutScene(() => {
              // Always add double journey points for teamwork
              score += difficultySettings[currentDifficulty].pointsPerChoice * 2;
              energy = energy - difficultySettings[currentDifficulty].energyPenalty; // Lose energy for the effort
              window.broomCutScene = false;
              if (typeof choice.next === "number") {
                currentStep = choice.next;
              } else {
                currentStep++;
              }
              showStep();
              showDidYouKnow();
            });
            return;
          }
          // For all other steps, add points based on difficulty
          if (!window.skipJourneyPointsThisStep) {
            score += difficultySettings[currentDifficulty].pointsPerChoice;
          } else {
            // If skipJourneyPointsThisStep is true, do not add journey points
            window.skipJourneyPointsThisStep = false; // Reset the flag for next step
          }
          if (typeof choice.next === "number") {
            currentStep = choice.next;
          } else {
            currentStep++;
          }
          showStep();
          showDidYouKnow();
        };
        choicesContainer.appendChild(btn);
      });

      updateStatus();
      updateScoreDisplay(); // Update score visually

      // Check for the snake wait cut scene
      if (window.snakeWaitCutScene) {
        // Show the cut scene and then continue
        showSnakeWaitCutScene(() => {
          window.snakeWaitCutScene = false;
          currentStep = 5;
          showStep();
          showDidYouKnow();
        });
        return;
      }

      // Check for the snake walk around cut scene
      if (window.snakeWalkAroundCutScene) {
        showSnakeWalkAroundCutScene(() => {
          window.snakeWalkAroundCutScene = false;
          currentStep = 5;
          showStep();
          showDidYouKnow();
        });
        return;
      }
    }

    function updateStatus() {
      // Show Energy and Journey Points with goal in the status bar
      const winCondition = difficultySettings[currentDifficulty].winCondition;
      statusBar.textContent = `Energy: ${energy} | Journey Points: ${score} / ${winCondition}`;
      
      // Announce status changes to screen readers
      const announcement = `Current status: ${energy} energy remaining, ${score} of ${winCondition} journey points earned`;
      const srAnnouncement = document.createElement('div');
      srAnnouncement.setAttribute('aria-live', 'polite');
      srAnnouncement.setAttribute('aria-atomic', 'true');
      srAnnouncement.style.position = 'absolute';
      srAnnouncement.style.left = '-9999px';
      srAnnouncement.textContent = announcement;
      document.body.appendChild(srAnnouncement);
      
      // Remove announcement after it's read
      setTimeout(() => {
        document.body.removeChild(srAnnouncement);
      }, 1000);
    }

    function endGame() {
      choicesContainer.innerHTML = '';
      stopAmbient();

      const winCondition = difficultySettings[currentDifficulty].winCondition;

      // Check if player won based on difficulty settings
      if (currentStep === 7 && score >= winCondition) {
        // Move through the return journey positions gradually
        setTimeout(() => moveCharacter(8), 500);   // Start journey back
        setTimeout(() => moveCharacter(9), 1500);  // Halfway back
        setTimeout(() => moveCharacter(10), 2500); // Almost home
        setTimeout(() => moveCharacter(11), 3500); // Return to village
        
        setBackground(currentStep);
        showWellCelebrationScene(true, score, winCondition, difficultySettings[currentDifficulty].name);
        
        // Clear VICTORY message with prominent styling - now simplified since victory info is in the well scene
        storyText.innerHTML = `
          <div style="background: rgba(255, 255, 255, 0.9); padding: 15px; border-radius: 8px; color: #005073; text-align: center;">
            <div style="font-size: 1.3em; font-weight: bold; margin-bottom: 10px; color: #4FCB53;">
              🌟 Congratulations! You've helped transform a community! 🌟
            </div>
            <div style="font-size: 1em; line-height: 1.4;">
              You made it! With clean water, your family is healthier and happier. Thanks to your choices, the village can now thrive!<br><br>
              <span style="color: #2E9DF7; font-weight: bold;">Your journey makes a real difference in the world.</span>
            </div>
          </div>
        `;
        
        playSound(sfxVictory);
        const box = document.getElementById('didYouKnow');
        box.innerHTML = `<strong>Did You Know?</strong> ${didYouKnowFacts[didYouKnowFacts.length - 1]}`;
        box.style.display = 'block';
        box.style.opacity = '1';
        storyText.focus();
        const restart = document.createElement('button');
        restart.classList.add('choiceBtn');
        restart.textContent = 'Play Again';
        restart.onclick = () => {
          // Go back to landing page to allow difficulty change
          const landingPage = document.getElementById('landingPage');
          const gameContainer = document.getElementById('gameContainer');
          
          gameContainer.style.display = 'none';
          gameContainer.setAttribute('aria-hidden', 'true');
          
          landingPage.style.display = 'flex';
          landingPage.setAttribute('aria-hidden', 'false');
          
          landingPage.focus();
          hideWellScene();
        };
        choicesContainer.appendChild(restart);
        updateStatus();
        updateScoreDisplay();
        return;
      }
      // If you finished the journey but have less than required points
      if (currentStep === 7 && score < winCondition) {
        moveCharacter(8); // Move to first return position even if not enough points
        setBackground(currentStep);
        
        // Clear message for insufficient points
        storyText.innerHTML = `
          <div style="background: linear-gradient(135deg, #FF902A 0%, #F5402C 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; text-align: center; box-shadow: 0 4px 12px rgba(245, 64, 44, 0.3);">
            <div style="font-size: 1.8em; font-weight: bold; margin-bottom: 8px;">😔 JOURNEY INCOMPLETE</div>
            <div style="font-size: 1.2em; margin-bottom: 10px;">You reached the water, but didn't earn enough points</div>
            <div style="background: rgba(255, 255, 255, 0.2); padding: 8px; border-radius: 6px; font-size: 1em;">
              <strong>${difficultySettings[currentDifficulty].name} Mode:</strong> You earned <span style="color: #FFC907; font-weight: bold;">${score} Journey Points</span><br>
              <span style="color: #FFC907;">You needed ${winCondition} points to win</span>
            </div>
          </div>
          <div style="background: rgba(255, 255, 255, 0.9); padding: 15px; border-radius: 8px; color: #005073;">
            You made it to the water source, but your choices along the way weren't optimal. Try again and make better decisions to help your village thrive!
          </div>
        `;
        
        playSound(sfxLoss);
        const restart = document.createElement('button');
        restart.classList.add('choiceBtn');
        restart.textContent = 'Try Again';
        restart.onclick = () => {
          // Go back to landing page to allow difficulty change
          const landingPage = document.getElementById('landingPage');
          const gameContainer = document.getElementById('gameContainer');
          
          gameContainer.style.display = 'none';
          gameContainer.setAttribute('aria-hidden', 'true');
          
          landingPage.style.display = 'flex';
          landingPage.setAttribute('aria-hidden', 'false');
          
          landingPage.focus();
        };
        choicesContainer.appendChild(restart);
        updateStatus();
        updateScoreDisplay();
        return;
      }
      // If energy is 0, show the Game Over cut scene
      if (energy <= 0) {
        moveCharacter(currentStep);
        setBackground(currentStep);
        
        // Clear GAME OVER message with prominent styling
        storyText.innerHTML = `
          <div style="background: linear-gradient(135deg, #8B0000 0%, #FF0000 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; text-align: center; box-shadow: 0 4px 12px rgba(139, 0, 0, 0.4);">
            <div style="font-size: 1.8em; font-weight: bold; margin-bottom: 8px;">💔 GAME OVER</div>
            <div style="font-size: 1.2em; margin-bottom: 10px;">You ran out of energy and couldn't continue</div>
            <div style="background: rgba(255, 255, 255, 0.2); padding: 8px; border-radius: 6px; font-size: 1em;">
              <strong>Energy Depleted:</strong> 0 energy remaining<br>
              <span style="color: #FFC907;">You earned ${score} Journey Points before stopping</span>
            </div>
          </div>
          <div style="background: rgba(255, 255, 255, 0.9); padding: 15px; border-radius: 8px; color: #005073;">
            Without energy, you had to turn back. Your family will have to wait another day for water. Try again and make choices that preserve your energy!
          </div>
        `;
        
        playSound(sfxLoss);
        // Show last fact (link to stories)
        const box = document.getElementById('didYouKnow');
        box.innerHTML = `<strong>Did You Know?</strong> ${didYouKnowFacts[didYouKnowFacts.length - 1]}`;
        box.style.display = 'block';
        box.style.opacity = '1';
      } else {
        moveCharacter(8); // Move to first return position for successful completion

        // Show a special well scene at the end
        showWellCelebrationScene(false, score, 0, 'Journey');

        // Only show a simple ending message (removed schoolProgress logic)
        storyText.innerHTML = `
          <div style="background: rgba(255, 255, 255, 0.9); padding: 15px; border-radius: 8px; color: #005073; text-align: center;">
            <div style="font-size: 1.3em; font-weight: bold; margin-bottom: 10px; color: #4FCB53;">
              🌟 Well done! You completed the journey! 🌟
            </div>
            <div style="font-size: 1em; line-height: 1.4;">
              You made it! With clean water, your family is healthier and happier.<br><br>
              <span style="color: #2E9DF7; font-weight: bold;">Every step of the journey matters.</span>
            </div>
          </div>
        `;
        
        playSound(sfxVictory);
        // Show last fact (link to stories)
        const box = document.getElementById('didYouKnow');
        box.innerHTML = `<strong>Did You Know?</strong> ${didYouKnowFacts[didYouKnowFacts.length - 1]}`;
        box.style.display = 'block';
        box.style.opacity = '1';
      }
      storyText.focus();        const restart = document.createElement('button');
        restart.classList.add('choiceBtn');
        restart.textContent = 'Play Again';
        restart.onclick = () => {
          // Go back to landing page to allow difficulty change
          const landingPage = document.getElementById('landingPage');
          const gameContainer = document.getElementById('gameContainer');
          
          gameContainer.style.display = 'none';
          gameContainer.setAttribute('aria-hidden', 'true');
          
          landingPage.style.display = 'flex';
          landingPage.setAttribute('aria-hidden', 'false');
          
          landingPage.focus();
          hideWellScene();
        };
      choicesContainer.appendChild(restart);
      updateStatus();
      updateScoreDisplay(); // Show final score
      // Show a summary message based on score and difficulty
      const scoreArea = document.getElementById('scoreArea');
      if (scoreArea) {
        const winCondition = difficultySettings[currentDifficulty].winCondition;
        let msg = "";
        let msgColor = "";
        let statusIcon = "";
        
        if (score >= winCondition + 5) {
          msg = `Outstanding! You exceeded the goal by ${score - winCondition} points!`;
          msgColor = "#4FCB53";
          statusIcon = "🌟";
        } else if (score >= winCondition) {
          msg = `Excellent! You successfully completed ${difficultySettings[currentDifficulty].name} mode!`;
          msgColor = "#159A48";
          statusIcon = "✅";
        } else if (score >= winCondition - 2) {
          msg = `So close! You were only ${winCondition - score} points away from winning!`;
          msgColor = "#FF902A";
          statusIcon = "⚡";
        } else {
          msg = `Keep trying! You need ${winCondition - score} more points to win!`;
          msgColor = "#F5402C";
          statusIcon = "🎯";
        }
        
        scoreArea.innerHTML = `
          <div style="background: rgba(255, 255, 255, 0.95); padding: 15px; border-radius: 10px; border: 2px solid ${msgColor}; margin-bottom: 10px;">
            <div style="font-size: 1.1em; color: #666; margin-bottom: 8px; font-weight: bold;">
              ${statusIcon} ${difficultySettings[currentDifficulty].name} Mode Results
            </div>
            <div style="font-size: 1.3em; margin-bottom: 8px;">
              Journey Points: <span style="color: ${msgColor}; font-weight: bold;">${score}</span> / ${winCondition}
            </div>
            <div style="color: ${msgColor}; font-weight: bold; font-size: 1em;">
              ${msg}
            </div>
          </div>
        `;
      }
    }

    // Show a well celebration scene at the end of the game with victory information
    function showWellCelebrationScene(isVictory = false, score = 0, winCondition = 0, difficulty = 'Normal') {
      // Remove any previous well scene if present
      let oldWell = document.getElementById('wellCelebrationScene');
      if (oldWell) oldWell.remove();

      // Play celebration sounds based on victory status
      if (isVictory) {
        playSound(sfxCelebration);
        setTimeout(() => playSound(sfxWaterSplash), 500);
        setTimeout(() => playSound(sfxCommunity), 1000);
        setTimeout(() => playSound(sfxLaughter), 1500);
      } else {
        playSound(sfxCommunity);
        setTimeout(() => playSound(sfxWaterSplash), 400);
      }

      // Create a new div for the well scene
      const wellDiv = document.createElement('div');
      wellDiv.id = 'wellCelebrationScene';
      wellDiv.style.position = 'absolute';
      wellDiv.style.left = '50%';
      wellDiv.style.top = '50%';
      wellDiv.style.transform = 'translate(-50%, -50%)';
      wellDiv.style.zIndex = '25';
      wellDiv.style.background = 'rgba(255,255,255,0.98)';
      wellDiv.style.borderRadius = '15px';
      wellDiv.style.boxShadow = '0 6px 30px rgba(0,0,0,0.3)';
      wellDiv.style.padding = '25px 30px';
      wellDiv.style.textAlign = 'center';
      wellDiv.style.maxWidth = '500px';
      wellDiv.style.border = isVictory ? '3px solid #4FCB53' : '3px solid #2E9DF7';

      // Create different content based on victory status
      if (isVictory) {
        wellDiv.innerHTML = `
          <div style="background: linear-gradient(135deg, #4FCB53 0%, #159A48 100%); color: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
            <div style="font-size: 1.6em; font-weight: bold; margin-bottom: 5px;">🎉 VICTORY! 🎉</div>
            <div style="font-size: 1.1em;">You successfully completed the water journey!</div>
          </div>
          
          <img src="img/Girl with cup of water..jpg" alt="Girl celebrating with clean water" style="max-width:150px; height:auto; margin-bottom:15px; border-radius:10px; border:3px solid #FFC907;">
          
          <div style="background: rgba(79, 203, 83, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #4FCB53;">
            <div style="font-size: 1.1em; font-weight: bold; color: #005073; margin-bottom: 5px;">
              ${difficulty} Mode Completed!
            </div>
            <div style="font-size: 1em; color: #005073;">
              You earned <span style="color: #4FCB53; font-weight: bold;">${score} Journey Points</span> (needed ${winCondition})
            </div>
          </div>
          
          <div style="color:#2E9DF7; font-size:1.1em; font-weight:bold;">
            🎉 Thanks to <span style="color:#FFC907;">charity: water</span>, your village has a new well! 🎉<br>
            <span style="color:#159A48; font-size: 0.95em;">Now you don't have to walk so far for water.</span>
          </div>
          
          <div style="margin-top: 15px; padding: 10px; background: rgba(255, 201, 7, 0.1); border-radius: 6px; border: 1px solid #FFC907;">
            <div style="font-size: 0.9em; color: #005073;">
              <strong>Your choices made a difference!</strong><br>
              Clean water transforms communities around the world.
            </div>
          </div>
        `;
      } else {
        wellDiv.innerHTML = `
          <div style="background: linear-gradient(135deg, #2E9DF7 0%, #005073 100%); color: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
            <div style="font-size: 1.6em; font-weight: bold; margin-bottom: 5px;">🌟 SUCCESS! 🌟</div>
            <div style="font-size: 1.1em;">You completed the water journey!</div>
          </div>
          
          <img src="img/Girl with cup of water..jpg" alt="Girl celebrating with clean water" style="max-width:150px; height:auto; margin-bottom:15px; border-radius:10px; border:3px solid #FFC907;">
          
          <div style="background: rgba(46, 157, 247, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #2E9DF7;">
            <div style="font-size: 1.1em; font-weight: bold; color: #005073; margin-bottom: 5px;">
              Journey Completed!
            </div>
            <div style="font-size: 1em; color: #005073;">
              You earned <span style="color: #2E9DF7; font-weight: bold;">${score} Journey Points</span>
            </div>
          </div>
          
          <div style="color:#2E9DF7; font-size:1.1em; font-weight:bold;">
            🎉 Thanks to <span style="color:#FFC907;">charity: water</span>, your village has clean water! 🎉<br>
            <span style="color:#159A48; font-size: 0.95em;">Your family is healthier and happier.</span>
          </div>
        `;
      }
      
      document.getElementById('gameContainer').appendChild(wellDiv);
      
      // Auto-hide after 8 seconds to show the main content underneath
      setTimeout(() => {
        if (wellDiv.parentNode) {
          wellDiv.style.transition = 'opacity 1s ease-out';
          wellDiv.style.opacity = '0';
          setTimeout(() => {
            if (wellDiv.parentNode) {
              wellDiv.remove();
            }
          }, 1000);
        }
      }, 8000);
    }

    // Optionally hide the well scene if needed
    function hideWellScene() {
      let oldWell = document.getElementById('wellCelebrationScene');
      if (oldWell) oldWell.remove();
    }

    // Hide landing page and start game when Start Game is clicked
    document.getElementById('startGameBtn').onclick = function() {
      // Hide the landing page
      const landingPage = document.getElementById('landingPage');
      const gameContainer = document.getElementById('gameContainer');
      
      landingPage.style.display = 'none';
      landingPage.setAttribute('aria-hidden', 'true');
      
      gameContainer.style.display = 'block';
      gameContainer.setAttribute('aria-hidden', 'false');
      
      // Focus on the game container for screen readers
      gameContainer.focus();
      
      // Start the game
      startGame();
    };

    // Add event listener for the Reset button
    document.getElementById('resetBtn').onclick = function() {
      // Stop any ambient sounds
      stopAmbient();
      
      // Hide the game container
      const landingPage = document.getElementById('landingPage');
      const gameContainer = document.getElementById('gameContainer');
      
      gameContainer.style.display = 'none';
      gameContainer.setAttribute('aria-hidden', 'true');
      
      landingPage.style.display = 'flex';
      landingPage.setAttribute('aria-hidden', 'false');
      
      // Focus on the landing page for screen readers
      landingPage.focus();
      
      // Reset any overlays that might be showing
      const overlays = ['directionsCutScene', 'schoolEndingScene', 'glassCutScene', 'wellCelebrationScene', 'snakeBiteScene', 'goAloneScene', 'snakeWaitCutScene', 'lostInBrushCutScene', 'muddyPatchRestCutScene', 'muddyPatchPushThroughCutScene', 'wildDogCutScene', 'dirtyWaterCutScene', 'broomCutScene'];
      overlays.forEach(overlayId => {
        const overlay = document.getElementById(overlayId);
        if (overlay) overlay.remove();
      });
    };

    // Function to show a gentle overlay scene if the player chooses 'Go to school'
    function showSchoolEndingScene(message) {
      // Remove any previous overlay if present
      let oldOverlay = document.getElementById('schoolEndingScene');
      if (oldOverlay) oldOverlay.remove();

      // Create a new overlay div
      const overlay = document.createElement('div');
      overlay.id = 'schoolEndingScene';
      overlay.style.position = 'absolute';
      overlay.style.left = '0';
      overlay.style.top = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.background = 'rgba(255,255,255,0.97)';
      overlay.style.display = 'flex';
      overlay.style.flexDirection = 'column';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.zIndex = '30';
      overlay.style.textAlign = 'center';

      // Add a gentle message and a Restart button
      overlay.innerHTML = `
        <img src="img/Girl with cup of water..jpg" alt="Girl with clean water" style="max-width: 120px; height: auto; border-radius: 8px; border: 2px solid #FFC907; margin-bottom: 12px;">
        <div style="font-size:1.3em; color:#005073; font-weight:bold; margin-bottom:18px; max-width:400px;">
          ${message}
        </div>
        <div style="font-size:1em; color:#222; margin-bottom:18px; max-width:400px;">
          Your family is proud of your learning, but tonight there is less water and food to share. <br> <span style='color:#FFC907;'>Clean water helps everyone thrive!</span>
        </div>
        <button id="restartSchoolBtn" class="choiceBtn" style="max-width:200px; background-color:#2E9DF7;">Restart</button>
      `;
      // Add the overlay to the game container
      document.getElementById('gameContainer').appendChild(overlay);

      // Add event listener for the Restart button
      document.getElementById('restartSchoolBtn').onclick = function() {
        overlay.remove(); // Remove the overlay
        // Go back to landing page to allow difficulty change
        const landingPage = document.getElementById('landingPage');
        const gameContainer = document.getElementById('gameContainer');
        
        gameContainer.style.display = 'none';
        gameContainer.setAttribute('aria-hidden', 'true');
        
        landingPage.style.display = 'flex';
        landingPage.setAttribute('aria-hidden', 'false');
        
        landingPage.focus();
      };
    }

    // Show a simple cut scene if glass breaks off in her sandal
    function showGlassCutScene(continueCallback) {
      // Remove any previous overlay if present
      let oldOverlay = document.getElementById('glassCutScene');
      if (oldOverlay) oldOverlay.remove();

      // Play glass breaking and gasp sounds
      playSound(sfxGlassBreak);
      setTimeout(() => playSound(sfxGasp), 400);

      // Create a new overlay div
      const overlay = document.createElement('div');
      overlay.id = 'glassCutScene';
      overlay.style.position = 'absolute';
      overlay.style.left = '0';
      overlay.style.top = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.background = 'rgba(255,255,255,0.97)';
      overlay.style.display = 'flex';
      overlay.style.flexDirection = 'column';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.zIndex = '30';
      overlay.style.textAlign = 'center';

      // Add a gentle message, a simple SVG, and a Continue button
      overlay.innerHTML = `
        <div style="font-size:1.2em; color:#F5402C; font-weight:bold; margin-bottom:10px; max-width:400px;">
          Ouch! Some glass broke off in your sandal. You need to slow down and be careful.
        </div>
        <div style="font-size:1em; color:#222; margin-bottom:12px; max-width:400px;">
          You lose <span style='color:#F5402C;'>1 Energy</span> and <span style='color:#2E9DF7;'>1 Journey Point</span>.
        </div>
        <svg width="80" height="60" viewBox="0 0 80 60" style="margin-bottom:16px;">
          <ellipse cx="40" cy="50" rx="30" ry="8" fill="#bfa77a"/>
          <rect x="30" y="30" width="20" height="12" rx="6" fill="#FFC907" stroke="#bfa100" stroke-width="2"/>
          <polygon points="40,38 44,44 36,44" fill="#F5402C" opacity="0.7"/>
          <rect x="38" y="44" width="4" height="8" rx="2" fill="#8d5524"/>
          <polyline points="42,44 44,48 40,50 36,48 38,44" fill="none" stroke="#6d4c24" stroke-width="2"/>
          <line x1="40" y1="44" x2="40" y2="50" stroke="#F5402C" stroke-width="2"/>
        </svg>
        <button id="continueGlassBtn" class="choiceBtn" style="max-width:200px; background-color:#2E9DF7;">Continue</button>
      `;
      document.getElementById('gameContainer').appendChild(overlay);

      // Add event listener for the Continue button
      document.getElementById('continueGlassBtn').onclick = function() {
        overlay.remove(); // Remove the overlay
        // Always subtract energy and journey point for running through glass based on difficulty
        energy = energy - difficultySettings[currentDifficulty].energyPenalty;
        score = score - 1; // Always subtract exactly 1 Journey Point (not difficulty-based)
        // Show a relevant fact about injuries from unsafe paths
        showSpecificFact("Every year, thousands of people are injured while walking long distances to collect water. Safe water access means safer communities.");
        if (typeof continueCallback === 'function') {
          continueCallback(); // Continue the journey
        }
      };
    }

    // Show a cut scene for teamwork with Amina to sweep away the glass
    function showBroomCutScene(continueCallback) {
      // Remove any previous overlay if present
      let oldOverlay = document.getElementById('broomCutScene');
      if (oldOverlay) oldOverlay.remove();

      // Play collaborative working sounds
      playSound(sfxThrow); // Sweeping sound
      setTimeout(() => playSound(sfxLaughter), 600); // Happy teamwork

      // Create a new overlay div
      const overlay = document.createElement('div');
      overlay.id = 'broomCutScene';
      overlay.style.position = 'absolute';
      overlay.style.left = '0';
      overlay.style.top = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.background = 'rgba(255,255,255,0.97)';
      overlay.style.display = 'flex';
      overlay.style.flexDirection = 'column';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.zIndex = '30';
      overlay.style.textAlign = 'center';

      // Add teamwork message, SVG, and Continue button
      overlay.innerHTML = `
        <div style="font-size:1.2em; color:#159A48; font-weight:bold; margin-bottom:10px; max-width:400px;">
          You and Amina find some sticks and make brooms.<br>
          Working together, you sweep away the glass so it's safe to walk!
        </div>
        <div style="font-size:1em; color:#222; margin-bottom:12px; max-width:400px;">
          You lose <span style='color:#F5402C;'>1 Energy</span> (it was hard work),<br>
          but you earn <span style='color:#2E9DF7;'>double Journey Points</span> for teamwork!
        </div>
        <svg width="90" height="60" viewBox="0 0 90 60" style="margin-bottom:16px;">
          <!-- Two stick brooms and some glass -->
          <rect x="20" y="40" width="6" height="18" rx="2" fill="#8d5524"/>
          <rect x="64" y="40" width="6" height="18" rx="2" fill="#8d5524"/>
          <ellipse cx="23" cy="58" rx="7" ry="4" fill="#FFC907"/>
          <ellipse cx="67" cy="58" rx="7" ry="4" fill="#FFC907"/>
          <polygon points="45,50 50,55 40,55" fill="#2E9DF7" opacity="0.5"/>
          <polygon points="55,52 60,57 50,57" fill="#2E9DF7" opacity="0.5"/>
        </svg>
        <button id="continueBroomBtn" class="choiceBtn" style="max-width:200px; background-color:#2E9DF7;">Continue</button>
      `;
      document.getElementById('gameContainer').appendChild(overlay);

      // Add event listener for the Continue button
      document.getElementById('continueBroomBtn').onclick = function() {
        overlay.remove(); // Remove the overlay
        // Show a fact about teamwork and community
        showSpecificFact("When communities work together on water projects, they're 5x more likely to succeed long-term. Teamwork creates lasting change!");
        if (typeof continueCallback === 'function') {
          continueCallback(); // Continue the journey
        }
      };
    }

    // Show a cut scene if the player is bitten by a snake
    function showSnakeBiteScene(continueCallback) {
      // Remove any previous overlay if present
      let oldOverlay = document.getElementById('snakeBiteScene');
      if (oldOverlay) oldOverlay.remove();

      // Play dramatic snake bite sounds
      playSound(sfxSnakeHiss);
      setTimeout(() => playSound(sfxGasp), 400);
      setTimeout(() => playSound(sfxHeart), 800); // Heartbeat from fear/pain

      // Create a new overlay div
      const overlay = document.createElement('div');
      overlay.id = 'snakeBiteScene';
      overlay.style.position = 'absolute';
      overlay.style.left = '0';
      overlay.style.top = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.background = 'rgba(255,255,255,0.97)';
      overlay.style.display = 'flex';
      overlay.style.flexDirection = 'column';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.zIndex = '30';
      overlay.style.textAlign = 'center';

      // Add a message, SVG, and a Continue button
      overlay.innerHTML = `
        <div style="font-size:1.2em; color:#F5402C; font-weight:bold; margin-bottom:10px; max-width:400px;">
          Oh no! You stumble and the snake bites you.<br>
          You become ill and must return home without water.
        </div>
        <div style="font-size:1em; color:#222; margin-bottom:12px; max-width:400px;">
          Your family will have to wait for water. Try again and be careful next time!
        </div>
        <svg width="90" height="60" viewBox="0 0 90 60" style="margin-bottom:16px;">
          <!-- Simple snake and bite illustration -->
          <ellipse cx="45" cy="50" rx="30" ry="8" fill="#bfa77a"/>
          <path d="M20 50 Q45 10 70 50" stroke="#159A48" stroke-width="6" fill="none"/>
          <circle cx="70" cy="50" r="6" fill="#159A48"/>
          <circle cx="72" cy="48" r="1.5" fill="#fff"/>
          <circle cx="68" cy="48" r="1.5" fill="#fff"/>
          <ellipse cx="70" cy="54" rx="2" ry="1" fill="#F5402C"/>
          <rect x="40" y="44" width="10" height="6" rx="2" fill="#c68642"/>
        </svg>
        <button id="continueSnakeBtn" class="choiceBtn" style="max-width:200px; background-color:#2E9DF7;">Continue</button>
      `;
      document.getElementById('gameContainer').appendChild(overlay);

      // Add event listener for the Continue button
      document.getElementById('continueSnakeBtn').onclick = function() {
        overlay.remove(); // Remove the overlay
        if (typeof continueCallback === 'function') {
          continueCallback(); // Continue the journey
        }
      };
    }

    // Show a cut scene if the player chooses to go alone
    function showGoAloneScene(continueCallback) {
      // Remove any previous overlay if present
      let oldOverlay = document.getElementById('goAloneScene');
      if (oldOverlay) oldOverlay.remove();

      // Play determined solo journey sounds
      playSound(sfxWalk);
      setTimeout(() => playSound(sfxWind), 500); // Wind emphasizing solitude

      // Create a new overlay div
      const overlay = document.createElement('div');
      overlay.id = 'goAloneScene';
      overlay.style.position = 'absolute';
      overlay.style.left = '0';
      overlay.style.top = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.background = 'rgba(255,255,255,0.97)';
      overlay.style.display = 'flex';
      overlay.style.flexDirection = 'column';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.zIndex = '30';
      overlay.style.textAlign = 'center';

      // Add a message, SVG, and a Continue button
      overlay.innerHTML = `
        <div style="font-size:1.2em; color:#159A48; font-weight:bold; margin-bottom:10px; max-width:400px;">
          Wow, you're brave and courteous.<br>
          Amina can stay and go to school today!
        </div>
        <div style="font-size:1em; color:#222; margin-bottom:12px; max-width:400px;">
          You will earn <span style='color:#2E9DF7;'>double Journey Points</span> for this step.
        </div>
        <img src="img/water-can.png" alt="Water container" style="max-width:80px; height:auto; margin-bottom:16px;">
        <button id="continueGoAloneBtn" class="choiceBtn" style="max-width:200px; background-color:#2E9DF7;">Continue</button>
      `;
      document.getElementById('gameContainer').appendChild(overlay);

      // Add event listener for the Continue button
      document.getElementById('continueGoAloneBtn').onclick = function() {
        overlay.remove(); // Remove the overlay
        if (typeof continueCallback === 'function') {
          continueCallback(); // Continue the journey
        }
      };
    }

    // Show a cut scene if the player waits for the snake to leave
    function showSnakeWaitCutScene(continueCallback) {
      // Remove any previous overlay if present
      let oldOverlay = document.getElementById('snakeWaitCutScene');
      if (oldOverlay) oldOverlay.remove();

      // Create a new overlay div
      const overlay = document.createElement('div');
      overlay.id = 'snakeWaitCutScene';
      overlay.style.position = 'absolute';
      overlay.style.left = '0';
      overlay.style.top = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.background = 'rgba(255,255,255,0.97)';
      overlay.style.display = 'flex';
      overlay.style.flexDirection = 'column';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.zIndex = '30';
      overlay.style.textAlign = 'center';

      // Add a message, SVG, and a Continue button
      overlay.innerHTML = `
        <div style="font-size:1.2em; color:#159A48; font-weight:bold; margin-bottom:10px; max-width:400px;">
          You wait quietly and the snake finally slithers away.<br>
          This was a safe choice, but it took a long time and you lost some time on your journey.
        </div>
        <div style="font-size:1em; color:#222; margin-bottom:12px; max-width:400px;">
          You lose <span style='color:#F5402C;'>2 Journey Points</span> because you had to wait.
        </div>
        <svg width="90" height="60" viewBox="0 0 90 60" style="margin-bottom:16px;">
          <!-- Simple snake illustration -->
          <ellipse cx="45" cy="50" rx="30" ry="8" fill="#bfa77a"/>
          <path d="M20 50 Q45 20 70 50" stroke="#159A48" stroke-width="6" fill="none"/>
        </svg>
        <button id="continueSnakeWaitBtn" class="choiceBtn" style="max-width:200px; background-color:#2E9DF7;">Continue</button>
      `;
      document.getElementById('gameContainer').appendChild(overlay);

      // Add event listener for the Continue button
      document.getElementById('continueSnakeWaitBtn').onclick = function() {
        overlay.remove(); // Remove the overlay
        // Subtract 2 Journey Points for waiting
        score = score - 2;
        // Call the callback to continue the journey
        if (typeof continueCallback === 'function') {
          continueCallback();
        }
      };
    }

    // Add a simple cut scene for getting lost in the brush
    function showLostInBrushCutScene() {
      // Remove any previous overlay if present
      let oldOverlay = document.getElementById('lostInBrushCutScene');
      if (oldOverlay) oldOverlay.remove();

      // Create a new overlay div
      const overlay = document.createElement('div');
      overlay.id = 'lostInBrushCutScene';
      overlay.style.position = 'absolute';
      overlay.style.left = '0';
      overlay.style.top = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.background = 'rgba(255,255,255,0.97)';
      overlay.style.display = 'flex';
      overlay.style.flexDirection = 'column';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.zIndex = '40';
      overlay.style.textAlign = 'center';

      // Add a message, SVG, and a Continue button
      overlay.innerHTML = `
        <div style="font-size:1.2em; color:#F5402C; font-weight:bold; margin-bottom:10px; max-width:400px;">
          You get lost in the thick brush and can't find your way back.<br>
          You are too tired to continue.
        </div>
        <svg width="90" height="60" viewBox="0 0 90 60" style="margin-bottom:16px;">
          <!-- Simple lost in brush illustration -->
          <ellipse cx="45" cy="50" rx="30" ry="8" fill="#bfa77a"/>
          <ellipse cx="30" cy="40" rx="10" ry="14" fill="#159A48" opacity="0.7"/>
          <ellipse cx="60" cy="40" rx="10" ry="14" fill="#159A48" opacity="0.7"/>
          <ellipse cx="45" cy="45" rx="12" ry="10" fill="#4FCB53" opacity="0.5"/>
        </svg>
        <button id="continueLostBrushBtn" class="choiceBtn" style="max-width:200px; background-color:#2E9DF7;">Continue</button>
      `;
      document.getElementById('gameContainer').appendChild(overlay);

      // When the player clicks Continue, end the game for real
      document.getElementById('continueLostBrushBtn').onclick = function() {
        overlay.remove(); // Remove the overlay
        // Set energy to 0 so the ending message is clear
        energy = 0;
        // Call endGame() to stop the game and show the ending
        endGame();
      };
    }

    // Show a cut scene for 'Rest for a moment' at the muddy patch
   
    // This function is called when the player chooses to rest in the mud
    function showMuddyPatchRestCutScene(continueCallback) {
      // Remove any previous overlay if present
      let oldOverlay = document.getElementById('muddyPatchRestCutScene');
      if (oldOverlay) oldOverlay.remove();

      // Play peaceful rest sounds
      playSound(sfxRest);
      setTimeout(() => playSound(sfxBirds), 800); // Birds chirping during rest
      setTimeout(() => playSound(sfxWind), 1500); // Gentle wind

      // Create a new overlay div
      const overlay = document.createElement('div');
      overlay.id = 'muddyPatchRestCutScene';
      overlay.style.position = 'absolute';
      overlay.style.left = '0';
      overlay.style.top = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.background = 'rgba(255,255,255,0.97)';
      overlay.style.display = 'flex';
      overlay.style.flexDirection = 'column';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.zIndex = '40';
      overlay.style.textAlign = 'center';

      // Add a message and a Continue button
      overlay.innerHTML = `
        <div style="font-size:1.2em; color:#159A48; font-weight:bold; margin-bottom:10px; max-width:400px;">
          You rest for a moment and catch your breath.<br>
          You feel a little better and gain 2 Energy.
        </div>
        <svg width="90" height="60" viewBox="0 0  90 60" style="margin-bottom:16px;">
          <ellipse cx="45" cy="50" rx="30" ry="8" fill="#bfa77a"/>
          <ellipse cx="45" cy="40" rx="15" ry="10" fill="#8BD1CB" opacity="0.7"/>
          <ellipse cx="45" cy="45" rx="12" ry="8" fill="#4FCB53" opacity="0.5"/>
        </svg>
        <button id="continueMuddyRestBtn" class="choiceBtn" style="max-width:200px; background-color:#2E9DF7;">Continue</button>
      `;
      document.getElementById('gameContainer').appendChild(overlay);

      // When the player clicks Continue, remove overlay and continue
      document.getElementById('continueMuddyRestBtn').onclick = function() {
        overlay.remove();
        // Show a fact about the importance of rest and self-care
        showSpecificFact("Taking breaks during long water journeys is essential. Many people walk 3-6 hours daily to collect water for their families.");
        if (typeof continueCallback === 'function') {
          continueCallback();
        }
      };
    }

    // Show a cut scene for 'Push through' at the muddy patch
    // This function is called when the player chooses to push through the mud
    function showMuddyPatchPushThroughCutScene(continueCallback) {
      // Remove any previous overlay if present
      let oldOverlay = document.getElementById('muddyPatchPushThroughCutScene');
      if (oldOverlay) oldOverlay.remove();

      // Play strenuous push-through sounds
      playSound(sfxWalk);
      setTimeout(() => playSound(sfxSplash), 400); // Splashing through mud
      setTimeout(() => playSound(sfxGasp), 800); // Exhaustion from effort

      // Create a new overlay div
      const overlay = document.createElement('div');
      overlay.id = 'muddyPatchPushThroughCutScene';
      overlay.style.position = 'absolute';
      overlay.style.left = '0';
      overlay.style.top = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.background = 'rgba(255,255,255,0.97)';
      overlay.style.display = 'flex';
      overlay.style.flexDirection = 'column';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.zIndex = '40';
      overlay.style.textAlign = 'center';

      // Add a message and a Continue button
      overlay.innerHTML = `
        <div style="font-size:1.2em; color:#F5402C; font-weight:bold; margin-bottom:10px; max-width:400px;">
          You push through the mud and keep going.<br>
          It's hard work and you lose 2 Energy.
        </div>
        <svg width="90" height="60" viewBox="0 0 90 60" style="margin-bottom:16px;">
          <ellipse cx="45" cy="50" rx="30" ry="8" fill="#bfa77a"/>
          <ellipse cx="45" cy="45" rx="18" ry="7" fill="#8d5524" opacity="0.7"/>
          <ellipse cx="45" cy="48" rx="12" ry="5" fill="#F5402C" opacity="0.5"/>
        </svg>
        <button id="continueMuddyPushBtn" class="choiceBtn" style="max-width:200px; background-color:#2E9DF7;">Continue</button>
      `;
      document.getElementById('gameContainer').appendChild(overlay);

      // When the player clicks Continue, remove overlay and continue
      document.getElementById('continueMuddyPushBtn').onclick = function() {
        overlay.remove();
        if (typeof continueCallback === 'function') {
          continueCallback();
        }
      };
    }

    // Show a cut scene for the wild dog event
    function showWildDogCutScene(continueCallback) {
      // Remove any previous overlay if present
      let oldOverlay = document.getElementById('wildDogCutScene');
      if (oldOverlay) oldOverlay.remove();

      // Play dramatic dog encounter sounds
      playSound(sfxDogBark);
      setTimeout(() => playSound(sfxThrow), 500); // Throwing distraction
      setTimeout(() => playSound(sfxWalk), 800); // Running away quickly
      setTimeout(() => playSound(sfxHeart), 1200); // Racing heartbeat from adrenaline

      // Create a new overlay div
      const overlay = document.createElement('div');
      overlay.id = 'wildDogCutScene';
      overlay.style.position = 'absolute';
      overlay.style.left = '0';
      overlay.style.top = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.background = 'rgba(255,255,255,0.97)';
      overlay.style.display = 'flex';
      overlay.style.flexDirection = 'column';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.zIndex = '40';
      overlay.style.textAlign = 'center';

      // Add a message, SVG, and a Continue button
      overlay.innerHTML = `
        <div style="font-size:1.2em; color:#F5402C; font-weight:bold; margin-bottom:10px; max-width:400px;">
          You throw a stick into the brush and run past the wild dog, yelling.<br>
          That was scary! You lose 2 Energy.
        </div>
        <svg width="90" height="60" viewBox="0 0 90 60" style="margin-bottom:16px;">
          <ellipse cx="45" cy="50" rx="30" ry="8" fill="#bfa77a"/>
          <ellipse cx="60" cy="45" rx="10" ry="6" fill="#8d5524"/>
          <ellipse cx="60" cy="40" rx="7" ry="4" fill="#c68642"/>
          <ellipse cx="65" cy="38" rx="2" ry="2" fill="#fff"/>
          <ellipse cx="55" cy="38" rx="2" ry="2" fill="#fff"/>
          <ellipse cx="60" cy="48" rx="4" ry="2" fill="#F5402C" opacity="0.5"/>
          <rect x="30" y="48" width="18" height="3" rx="1.5" fill="#8d5524"/>
        </svg>
        <button id="continueWildDogBtn" class="choiceBtn" style="max-width:200px; background-color:#2E9DF7;">Continue</button>
      `;
      document.getElementById('gameContainer').appendChild(overlay);

      // When the player clicks Continue, remove overlay and continue
      document.getElementById('continueWildDogBtn').onclick = function() {
        overlay.remove();
        if (typeof continueCallback === 'function') {
          continueCallback();
        }
      };
    }

    // Add the dirty water cut scene function
    function showDirtyWaterCutScene(continueCallback) {
      // Remove any previous overlay if present
      let oldOverlay = document.getElementById('dirtyWaterCutScene');
      if (oldOverlay) oldOverlay.remove();

      // Create a new overlay div
      const overlay = document.createElement('div');
      overlay.id = 'dirtyWaterCutScene';
      overlay.style.position = 'absolute';
      overlay.style.left = '0';
      overlay.style.top = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.background = 'rgba(255,255,255,0.97)';
      overlay.style.display = 'flex';
      overlay.style.flexDirection = 'column';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.zIndex = '40';
      overlay.style.textAlign = 'center';

      // Add a message, SVG, and a Continue button
      overlay.innerHTML = `
        <div style="font-size:1.2em; color:#F5402C; font-weight:bold; margin-bottom:10px; max-width:400px;">
          You fill your container, but the water is full of bugs and dirt.<br>
          You have to pour it all out. What a waste of time and energy!
        </div>
        <div style="font-size:1em; color:#222; margin-bottom:12px; max-width:400px;">
          You lose <span style='color:#F5402C;'>1 Energy</span>.
        </div>
        <img src="img/clean and dirty water cups.jpg" alt="Clean vs dirty water" style="max-width:200px; height:auto; margin-bottom:16px; border-radius:8px; border:2px solid #FFC907;">
        <button id="continueDirtyWaterBtn" class="choiceBtn" style="max-width:200px; background-color:#2E9DF7;">Continue</button>
      `;
      document.getElementById('gameContainer').appendChild(overlay);

      // When the player clicks Continue, remove overlay and continue
      document.getElementById('continueDirtyWaterBtn').onclick = function() {
        overlay.remove();
        if (typeof continueCallback === 'function') {
          continueCallback();
        }
      };
    }
  </script>

  <!-- Footer with charity: water credit -->
  <footer role="contentinfo" style="position: fixed; bottom: 0; left: 0; right: 0; background: linear-gradient(135deg, #2E9DF7, #FFC907); color: #fff; text-align: center; padding: 8px 10px; font-size: 0.9em; font-weight: bold; box-shadow: 0 -2px 4px rgba(0,0,0,0.1); z-index: 1000;">
    Inspired by <a href="https://www.charitywater.org/" target="_blank" rel="noopener" style="color: #fff; text-decoration: underline;" aria-label="Visit charity: water website to learn more and donate">charity: water</a> 💧
  </footer>
</body>
</html>
